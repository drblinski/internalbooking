// =============================================================================
// BOULEVARD ADMIN API QUERIES - REAL DATA IMPLEMENTATION
// =============================================================================

// API Helper Function
async function queryBoulevard(query, variables = {}) {
  const response = await fetch('/api/blvd', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      query: query,
      variables: variables
    })
  });
  
  if (!response.ok) {
    throw new Error(`API request failed: ${response.status}`);
  }
  
  const data = await response.json();
  
  if (data.errors && data.errors.length > 0) {
    console.error('GraphQL errors:', data.errors);
    throw new Error(`GraphQL Error: ${data.errors[0].message}`);
  }
  
  return data.data;
}

// =============================================================================
// 1. FETCH ALL REAL STAFF WITH LOCATIONS
// =============================================================================

const STAFF_QUERY = `
  query GetAllStaff($first: Int!) {
    staff(first: $first) {
      edges {
        node {
          id
          firstName
          lastName
          email
          active
          role {
            id
            name
          }
          locations {
            id
            name
          }
        }
      }
      pageInfo {
        hasNextPage
        endCursor
      }
    }
  }
`;

async function fetchAllStaff() {
  console.log('üîç Fetching all real staff...');
  
  try {
    const data = await queryBoulevard(STAFF_QUERY, { first: 100 });
    
    if (!data.staff || !data.staff.edges) {
      console.log('‚ö†Ô∏è No staff data returned');
      return [];
    }
    
    const staff = data.staff.edges
      .map(edge => edge.node)
      .filter(staff => staff.active); // Only active staff
    
    console.log(`‚úÖ Found ${staff.length} active staff members`);
    staff.forEach(s => {
      console.log(`  - ${s.firstName} ${s.lastName} (${s.role?.name || 'No role'}) - Locations: ${s.locations.map(l => l.name).join(', ')}`);
    });
    
    return staff;
    
  } catch (error) {
    console.error('‚ùå Failed to fetch staff:', error);
    return [];
  }
}

// =============================================================================
// 2. FETCH ALL LOCATIONS WITH BUSINESS HOURS
// =============================================================================

const LOCATIONS_QUERY = `
  query GetAllLocations($first: Int!) {
    locations(first: $first) {
      edges {
        node {
          id
          name
          businessName
          tz
          businessHours {
            day
            startTime
            endTime
            isClosed
          }
          isActive
        }
      }
    }
  }
`;

async function fetchAllLocations() {
  console.log('üè¢ Fetching all locations...');
  
  try {
    const data = await queryBoulevard(LOCATIONS_QUERY, { first: 50 });
    
    if (!data.locations || !data.locations.edges) {
      console.log('‚ö†Ô∏è No locations data returned');
      return [];
    }
    
    const locations = data.locations.edges
      .map(edge => edge.node)
      .filter(location => location.isActive);
    
    console.log(`‚úÖ Found ${locations.length} active locations`);
    locations.forEach(l => {
      console.log(`  - ${l.name} (${l.businessName})`);
    });
    
    return locations;
    
  } catch (error) {
    console.error('‚ùå Failed to fetch locations:', error);
    return [];
  }
}

// =============================================================================
// 3. FETCH SHIFTS FOR LOCATION AND DATE
// =============================================================================

const SHIFTS_QUERY = `
  query GetLocationShifts($locationId: ID!, $startIso8601: DateTime!, $endIso8601: DateTime!, $first: Int!) {
    shifts(
      locationId: $locationId,
      startIso8601: $startIso8601,
      endIso8601: $endIso8601,
      first: $first
    ) {
      edges {
        node {
          id
          staffId
          locationId
          date
          startTime
          endTime
          available
          staff {
            id
            firstName
            lastName
          }
          location {
            id
            name
          }
        }
      }
    }
  }
`;

async function fetchShifts(locationId, date) {
  console.log(`üìÖ Fetching shifts for location ${locationId} on ${date.toISOString().split('T')[0]}...`);
  
  try {
    // Create start and end of day in ISO format
    const startOfDay = new Date(date);
    startOfDay.setHours(0, 0, 0, 0);
    const endOfDay = new Date(date);
    endOfDay.setHours(23, 59, 59, 999);
    
    const data = await queryBoulevard(SHIFTS_QUERY, {
      locationId: locationId,
      startIso8601: startOfDay.toISOString(),
      endIso8601: endOfDay.toISOString(),
      first: 100
    });
    
    if (!data.shifts || !data.shifts.edges) {
      console.log(`‚ö†Ô∏è No shifts found for location ${locationId}`);
      return [];
    }
    
    const shifts = data.shifts.edges.map(edge => edge.node);
    
    console.log(`‚úÖ Found ${shifts.length} shifts for location`);
    shifts.forEach(shift => {
      const staffName = shift.staff ? `${shift.staff.firstName} ${shift.staff.lastName}` : 'Unknown Staff';
      console.log(`  - ${staffName}: ${shift.startTime} - ${shift.endTime} (Available: ${shift.available})`);
    });
    
    return shifts;
    
  } catch (error) {
    console.error(`‚ùå Failed to fetch shifts for location ${locationId}:`, error);
    return [];
  }
}

// =============================================================================
// 4. FETCH APPOINTMENTS FOR LOCATION AND DATE
// =============================================================================

const APPOINTMENTS_QUERY = `
  query GetLocationAppointments($locationId: ID!, $after: DateTime!, $before: DateTime!, $first: Int!) {
    appointments(
      locationId: $locationId,
      after: $after,
      before: $before,
      first: $first
    ) {
      edges {
        node {
          id
          startAt
          endAt
          state
          cancelled
          client {
            id
            firstName
            lastName
          }
          staff {
            id
            firstName
            lastName
          }
          location {
            id
            name
          }
          appointmentServices {
            id
            startAt
            endAt
            duration
            service {
              name
              category {
                name
              }
            }
            staff {
              id
              firstName
              lastName
            }
          }
        }
      }
    }
  }
`;

async function fetchAppointments(locationId, date) {
  console.log(`üìã Fetching appointments for location ${locationId} on ${date.toISOString().split('T')[0]}...`);
  
  try {
    const startOfDay = new Date(date);
    startOfDay.setHours(0, 0, 0, 0);
    const endOfDay = new Date(date);
    endOfDay.setHours(23, 59, 59, 999);
    
    const data = await queryBoulevard(APPOINTMENTS_QUERY, {
      locationId: locationId,
      after: startOfDay.toISOString(),
      before: endOfDay.toISOString(),
      first: 100
    });
    
    if (!data.appointments || !data.appointments.edges) {
      console.log(`‚ö†Ô∏è No appointments found for location ${locationId}`);
      return [];
    }
    
    const appointments = data.appointments.edges
      .map(edge => edge.node)
      .filter(apt => !apt.cancelled); // Filter out cancelled appointments
    
    console.log(`‚úÖ Found ${appointments.length} active appointments`);
    appointments.forEach(apt => {
      const clientName = apt.client ? `${apt.client.firstName} ${apt.client.lastName}` : 'No Client';
      const staffName = apt.staff ? `${apt.staff.firstName} ${apt.staff.lastName}` : 'No Staff';
      const startTime = new Date(apt.startAt).toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit',
        hour12: true 
      });
      console.log(`  - ${startTime}: ${clientName} with ${staffName}`);
    });
    
    return appointments;
    
  } catch (error) {
    console.error(`‚ùå Failed to fetch appointments for location ${locationId}:`, error);
    return [];
  }
}

// =============================================================================
// 5. COMPLETE DASHBOARD DATA LOADING
// =============================================================================

async function loadDashboardData(selectedDate) {
  console.log(`üîÑ Loading complete dashboard data for ${selectedDate.toISOString().split('T')[0]}...`);
  
  try {
    // Step 1: Load all staff and locations
    const [allStaff, allLocations] = await Promise.all([
      fetchAllStaff(),
      fetchAllLocations()
    ]);
    
    if (allStaff.length === 0) {
      console.error('‚ùå No staff found - check your Boulevard account setup');
      return { error: 'No staff found in Boulevard account' };
    }
    
    if (allLocations.length === 0) {
      console.error('‚ùå No locations found - check your Boulevard account setup');
      return { error: 'No locations found in Boulevard account' };
    }
    
    // Step 2: For each location, load shifts and appointments
    const locationData = await Promise.all(
      allLocations.map(async location => {
        console.log(`üè¢ Processing location: ${location.name}...`);
        
        const [shifts, appointments] = await Promise.all([
          fetchShifts(location.id, selectedDate),
          fetchAppointments(location.id, selectedDate)
        ]);
        
        // Step 3: Find staff working at this location
        const locationStaff = allStaff.filter(staff => 
          staff.locations.some(loc => loc.id === location.id)
        );
        
        // Step 4: Map shifts to staff
        const staffWithShifts = locationStaff.map(staff => {
          const staffShift = shifts.find(shift => shift.staffId === staff.id);
          return {
            ...staff,
            shift: staffShift || null,
            isWorking: !!staffShift && staffShift.available
          };
        });
        
        console.log(`‚úÖ ${location.name}: ${staffWithShifts.length} staff, ${shifts.length} shifts, ${appointments.length} appointments`);
        
        return {
          location: location,
          staff: staffWithShifts,
          shifts: shifts,
          appointments: appointments
        };
      })
    );
    
    console.log('‚úÖ Dashboard data loaded successfully');
    
    return {
      allStaff: allStaff,
      allLocations: allLocations,
      locationData: locationData
    };
    
  } catch (error) {
    console.error('‚ùå Failed to load dashboard data:', error);
    return { error: error.message };
  }
}

// =============================================================================
// 6. RENDER DASHBOARD WITH REAL DATA
// =============================================================================

function renderDashboard(dashboardData) {
  const container = document.getElementById('dashboard-container');
  
  if (dashboardData.error) {
    container.innerHTML = `
      <div class="error-state">
        <h3>Error Loading Data</h3>
        <p>${dashboardData.error}</p>
        <button onclick="loadAndRenderDashboard()">Retry</button>
      </div>
    `;
    return;
  }
  
  if (!dashboardData.locationData || dashboardData.locationData.length === 0) {
    container.innerHTML = `
      <div class="no-data-state">
        <h3>No Data Found</h3>
        <p>No locations or staff found in your Boulevard account.</p>
        <p>Please check your Boulevard setup and try again.</p>
        <button onclick="loadAndRenderDashboard()">Retry</button>
      </div>
    `;
    return;
  }
  
  // Clear container
  container.innerHTML = '';
  
  // Render each location
  dashboardData.locationData.forEach(locationInfo => {
    const locationPanel = createLocationPanel(locationInfo);
    container.appendChild(locationPanel);
  });
}

function createLocationPanel(locationInfo) {
  const panel = document.createElement('div');
  panel.className = 'location-panel';
  
  // Location header
  const header = document.createElement('div');
  header.className = 'location-header';
  header.innerHTML = `
    <h3>${locationInfo.location.name}</h3>
    <div class="location-stats">
      <span>${locationInfo.staff.length} staff</span>
      <span>${locationInfo.shifts.length} shifts</span>
      <span>${locationInfo.appointments.length} appointments</span>
    </div>
  `;
  panel.appendChild(header);
  
  // Staff list
  if (locationInfo.staff.length === 0) {
    const noStaff = document.createElement('div');
    noStaff.className = 'no-staff';
    noStaff.textContent = 'No staff assigned to this location';
    panel.appendChild(noStaff);
  } else {
    locationInfo.staff.forEach(staff => {
      const staffSection = createStaffSection(staff, locationInfo.appointments);
      panel.appendChild(staffSection);
    });
  }
  
  return panel;
}

function createStaffSection(staff, appointments) {
  const section = document.createElement('div');
  section.className = 'staff-section';
  
  const shiftInfo = staff.shift ? 
    `${staff.shift.startTime} - ${staff.shift.endTime}` : 
    'Not scheduled';
    
  const workingStatus = staff.isWorking ? 'working' : 'not-working';
  
  section.innerHTML = `
    <div class="staff-header ${workingStatus}">
      <div class="staff-name">${staff.firstName} ${staff.lastName}</div>
      <div class="staff-role">${staff.role?.name || 'No role'}</div>
      <div class="staff-shift">${shiftInfo}</div>
    </div>
  `;
  
  // Add appointment details if staff is working
  if (staff.isWorking) {
    const staffAppointments = appointments.filter(apt => 
      apt.staff && apt.staff.id === staff.id
    );
    
    if (staffAppointments.length > 0) {
      const appointmentsList = document.createElement('div');
      appointmentsList.className = 'appointments-list';
      
      staffAppointments.forEach(apt => {
        const startTime = new Date(apt.startAt).toLocaleTimeString('en-US', {
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });
        
        const clientName = apt.client ? 
          `${apt.client.firstName} ${apt.client.lastName}` : 
          'Client';
          
        appointmentsList.innerHTML += `
          <div class="appointment-item">
            ${startTime} - ${clientName}
          </div>
        `;
      });
      
      section.appendChild(appointmentsList);
    }
  }
  
  return section;
}

// =============================================================================
// 7. MAIN INITIALIZATION FUNCTION
// =============================================================================

async function loadAndRenderDashboard() {
  console.log('üöÄ Initializing Boulevard Dashboard...');
  
  // Show loading state
  const container = document.getElementById('dashboard-container');
  container.innerHTML = '<div class="loading-state">Loading real Boulevard data...</div>';
  
  // Get current date (or selected date)
  const selectedDate = new Date(); // You can change this to any date
  
  // Load and render data
  const dashboardData = await loadDashboardData(selectedDate);
  renderDashboard(dashboardData);
}

// =============================================================================
// 8. INITIALIZE ON PAGE LOAD
// =============================================================================

document.addEventListener('DOMContentLoaded', function() {
  console.log('üì± Page loaded, starting Boulevard dashboard...');
  loadAndRenderDashboard();
});

// Export functions for manual testing
window.boulevardAPI = {
  fetchAllStaff,
  fetchAllLocations,
  fetchShifts,
  fetchAppointments,
  loadDashboardData,
  loadAndRenderDashboard
};
