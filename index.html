<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Get Plump - Service Availability Dashboard</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      min-height: 100vh;
    }
    
    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .dashboard-header {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .dashboard-title {
      font-size: 28px;
      font-weight: 700;
      color: #1a1a1a;
    }
    
    .date-navigation {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .nav-button {
      background: #007AFF;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .nav-button:hover {
      background: #0056d6;
      transform: translateY(-1px);
    }
    
    .current-date {
      font-size: 18px;
      font-weight: 600;
      color: #1a1a1a;
      min-width: 200px;
      text-align: center;
    }
    
    .api-info {
      background: #e3f2fd;
      border: 1px solid #90caf9;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #1565c0;
    }
    
    .api-info h4 {
      margin-bottom: 8px;
      color: #0d47a1;
    }
    
    .test-button {
      background: #34c759;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 500;
      margin-left: 8px;
    }
    
    .test-button:hover {
      background: #30a752;
    }
    
    .dashboard-content {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .locations-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 1px;
      background: #e5e5e7;
    }
    
    .location-panel {
      background: #fff;
      padding: 24px;
      min-height: 400px;
    }
    
    .location-header {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #f5f5f5;
    }
    
    .location-name {
      font-size: 20px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 4px;
    }
    
    .location-address {
      font-size: 14px;
      color: #666;
    }
    
    .location-timezone {
      font-size: 12px;
      color: #888;
      margin-top: 4px;
    }
    
    .services-list {
      margin-top: 16px;
    }
    
    .service-item {
      border: 1px solid #f0f0f0;
      border-radius: 8px;
      margin-bottom: 12px;
      overflow: hidden;
      transition: all 0.2s;
    }
    
    .service-item:hover {
      border-color: #007AFF;
      box-shadow: 0 2px 8px rgba(0,123,255,0.1);
    }
    
    .service-header {
      padding: 16px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fafafa;
      transition: background 0.2s;
    }
    
    .service-header:hover {
      background: #f0f0f0;
    }
    
    .service-header.expanded {
      background: #e8f4f8;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .service-info {
      flex: 1;
    }
    
    .service-name {
      font-size: 16px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 4px;
    }
    
    .service-description {
      font-size: 14px;
      color: #666;
      margin-bottom: 4px;
    }
    
    .service-price {
      font-size: 14px;
      color: #007AFF;
      font-weight: 500;
    }
    
    .expand-indicator {
      font-size: 12px;
      color: #666;
      transition: transform 0.2s;
    }
    
    .expand-indicator.expanded {
      transform: rotate(180deg);
    }
    
    .service-details {
      display: none;
      padding: 0;
      background: #fff;
    }
    
    .service-details.expanded {
      display: block;
    }
    
    .staff-loading {
      padding: 20px;
      text-align: center;
      color: #666;
      font-style: italic;
    }
    
    .staff-list {
      padding: 16px;
    }
    
    .staff-item {
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-bottom: 8px;
      overflow: hidden;
      transition: all 0.2s;
    }
    
    .staff-item:hover {
      border-color: #007AFF;
      box-shadow: 0 2px 4px rgba(0,123,255,0.1);
    }
    
    .staff-header {
      padding: 12px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f9fa;
    }
    
    .staff-header:hover {
      background: #e9ecef;
    }
    
    .staff-header.expanded {
      background: #fff3cd;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .staff-info {
      flex: 1;
    }
    
    .staff-name {
      font-size: 14px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 2px;
    }
    
    .staff-details {
      font-size: 12px;
      color: #666;
    }
    
    .staff-price {
      font-size: 12px;
      color: #007AFF;
      font-weight: 500;
    }
    
    .times-section {
      display: none;
      padding: 12px;
      background: #fff;
      border-top: 1px solid #e0e0e0;
    }
    
    .times-section.expanded {
      display: block;
    }
    
    .times-loading {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 12px;
    }
    
    .times-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 6px;
      margin-top: 8px;
    }
    
    .time-slot {
      background: #e8f5e8;
      color: #2d5a2d;
      padding: 6px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid #c8e6c9;
    }
    
    .time-slot:hover {
      background: #c8e6c9;
      transform: translateY(-1px);
    }
    
    .no-times {
      text-align: center;
      color: #999;
      font-style: italic;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    
    .loading-state {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 300px;
      color: #666;
      font-size: 16px;
    }
    
    .error-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 300px;
      color: #d32f2f;
      text-align: center;
      padding: 20px;
    }
    
    .error-state h3 {
      margin-bottom: 12px;
      font-size: 18px;
    }
    
    .error-state p {
      margin-bottom: 8px;
      color: #666;
    }
    
    .error-state button {
      margin-top: 16px;
      background: #007AFF;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #007AFF;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .dashboard-container {
        padding: 10px;
      }
      
      .header-top {
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
      }
      
      .date-navigation {
        justify-content: center;
      }
      
      .locations-grid {
        grid-template-columns: 1fr;
      }
      
      .times-grid {
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="api-info">
      <h4>üöÄ Fast Loading Dashboard</h4>
      <p>This dashboard uses smart lazy-loading: locations and services load immediately, but staff and availability data only loads when you click to expand. This prevents rate limits and ensures blazing fast performance.</p>
    </div>
    
    <div class="dashboard-header">
      <div class="header-top">
        <h1 class="dashboard-title">Get Plump - Service Availability Dashboard</h1>
        
        <div class="date-navigation">
          <button class="nav-button" id="prevDay">‚Üê Previous</button>
          <div class="current-date" id="currentDate">Today</div>
          <button class="nav-button" id="nextDay">Next ‚Üí</button>
          <button class="test-button" id="testAPI">Test API</button>
        </div>
      </div>
    </div>
    
    <div class="dashboard-content">
      <div id="dashboard-container" class="locations-grid">
        <div class="loading-state">
          Loading business locations and services...
        </div>
      </div>
    </div>
  </div>

  <script>
    // =============================================================================
    // BOULEVARD CLIENT API CONFIGURATION
    // =============================================================================

    const BOULEVARD_CONFIG = {
      businessId: 'f6a06736-1132-4365-b79a-a69c648a746a',
      apiKey: '93ca3f15-6f0e-491d-840b-681a0fef80ed',
      endpoint: 'https://dashboard.boulevard.io/api/2020-01/f6a06736-1132-4365-b79a-a69c648a746a/client'
    };

    // Global State
    let currentDate = new Date();
    let dashboardData = {};
    let locationCarts = new Map(); // Cache carts per location to avoid recreation

    // Rate limiting: Simple queue to prevent parallel API calls
    let apiCallQueue = [];
    let isProcessingQueue = false;

    // =============================================================================
    // BOULEVARD CLIENT API HELPER WITH RATE LIMITING
    // =============================================================================

    /**
     * Makes a Boulevard Client API request with proper authentication
     * All API calls go through this function for consistent error handling
     */
    function makeBoulevardRequest(query, variables = {}) {
      console.log('üî• Making Boulevard Client API request...');
      console.log('Query:', query.substring(0, 100) + '...');
      console.log('Variables:', variables);
      
      return fetch(BOULEVARD_CONFIG.endpoint, {
        method: 'POST',
        headers: {
          'Authorization': 'Basic ' + btoa(BOULEVARD_CONFIG.apiKey + ':'),
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          query: query,
          variables: variables
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.errors && data.errors.length > 0) {
          console.error('GraphQL errors:', data.errors);
          throw new Error(data.errors[0].message);
        }
        console.log('‚úÖ API request successful');
        return data.data;
      });
    }

    /**
     * Queue API calls to prevent hitting rate limits
     * Only one API call processes at a time
     */
    async function queueApiCall(apiFunction) {
      return new Promise((resolve, reject) => {
        apiCallQueue.push({ apiFunction, resolve, reject });
        processQueue();
      });
    }

    async function processQueue() {
      if (isProcessingQueue || apiCallQueue.length === 0) return;
      
      isProcessingQueue = true;
      
      while (apiCallQueue.length > 0) {
        const { apiFunction, resolve, reject } = apiCallQueue.shift();
        
        try {
          const result = await apiFunction();
          resolve(result);
          // Small delay between API calls to be extra safe with rate limits
          await new Promise(r => setTimeout(r, 100));
        } catch (error) {
          reject(error);
        }
      }
      
      isProcessingQueue = false;
    }

    // =============================================================================
    // API CALL #1: FETCH BUSINESS LOCATIONS (ON PAGE LOAD)
    // =============================================================================

    const BUSINESS_LOCATIONS_QUERY = `
      query GetBusinessLocations {
        business {
          locations(first: 20) {
            edges {
              node {
                id
                name
                tz
                address {
                  line1
                  line2
                  city
                  state
                  zip
                }
              }
            }
          }
        }
      }
    `;

    /**
     * INITIAL LOAD: Fetch all business locations
     * This runs immediately on page load - no user interaction required
     */
    async function fetchBusinessLocations() {
      console.log('üè¢ INITIAL LOAD: Fetching business locations...');
      
      const data = await makeBoulevardRequest(BUSINESS_LOCATIONS_QUERY);
      
      if (!data.business?.locations?.edges) {
        throw new Error('No locations found in response');
      }
      
      const locations = data.business.locations.edges.map(edge => edge.node);
      console.log(`‚úÖ Found ${locations.length} business locations`);
      
      return locations;
    }

    // =============================================================================
    // API CALL #2: CREATE CART AND FETCH SERVICES (ON PAGE LOAD, PER LOCATION)
    // =============================================================================

    const CREATE_CART_QUERY = `
      mutation CreateCart($locationId: ID!) {
        createCart(input: { locationId: $locationId }) {
          cart {
            id
            availableCategories {
              name
              availableItems {
                id
                name
                description
                ... on CartAvailableBookableItem {
                  listPrice
                  listDuration
                }
              }
            }
          }
        }
      }
    `;

    /**
     * INITIAL LOAD: Create cart for location and fetch available services
     * This runs for each location on page load - no user interaction required
     */
    async function createCartAndFetchServices(locationId) {
      console.log(`üõí INITIAL LOAD: Creating cart for location ${locationId}...`);
      
      const data = await makeBoulevardRequest(CREATE_CART_QUERY, { locationId });
      
      if (!data.createCart?.cart) {
        throw new Error(`Failed to create cart for location ${locationId}`);
      }
      
      const cart = data.createCart.cart;
      
      // Cache the cart ID for this location
      locationCarts.set(locationId, cart.id);
      
      // Extract services from categories
      const services = [];
      if (cart.availableCategories) {
        cart.availableCategories.forEach(category => {
          if (category.availableItems) {
            category.availableItems.forEach(item => {
              services.push({
                ...item,
                categoryName: category.name
              });
            });
          }
        });
      }
      
      console.log(`‚úÖ Created cart ${cart.id}, found ${services.length} services`);
      return { cartId: cart.id, services };
    }

    // =============================================================================
    // API CALL #3: FETCH STAFF VARIANTS (ON SERVICE CLICK - USER INTERACTION)
    // =============================================================================

    const GET_STAFF_VARIANTS_QUERY = `
      query GetStaffVariants($cartId: ID!, $itemId: ID!) {
        cart(id: $cartId) {
          id
          availableItem(id: $itemId) {
            id
            name
            ... on CartAvailableBookableItem {
              staffVariants {
                id
                price
                duration
                staff {
                  id
                  firstName
                  lastName
                  bio
                }
              }
            }
          }
        }
      }
    `;

    /**
     * USER INTERACTION: Fetch staff variants when user clicks on a service
     * This is the first "expensive" API call that only runs on demand
     */
    async function fetchStaffVariants(cartId, serviceId) {
      console.log(`üë• USER CLICK: Fetching staff variants for service ${serviceId}...`);
      
      return queueApiCall(async () => {
        const data = await makeBoulevardRequest(GET_STAFF_VARIANTS_QUERY, { 
          cartId, 
          itemId: serviceId 
        });
        
        if (!data.cart?.availableItem?.staffVariants) {
          return [];
        }
        
        const staffVariants = data.cart.availableItem.staffVariants;
        console.log(`‚úÖ Found ${staffVariants.length} staff variants`);
        
        return staffVariants;
      });
    }

    // =============================================================================
    // API CALL #4: ADD SERVICE TO CART (ON STAFF CLICK - USER INTERACTION)
    // =============================================================================

    const ADD_SERVICE_TO_CART_QUERY = `
      mutation AddServiceToCart($cartId: ID!, $itemId: ID!, $staffVariantId: ID!) {
        addCartSelectedBookableItem(input: {
          id: $cartId,
          itemId: $itemId,
          itemStaffVariantId: $staffVariantId
        }) {
          cart { 
            id 
          }
        }
      }
    `;

    /**
     * USER INTERACTION: Add service/staff to cart when user clicks on staff member
     * Required before we can fetch available times
     */
    async function addServiceToCart(cartId, serviceId, staffVariantId) {
      console.log(`‚ûï USER CLICK: Adding service ${serviceId} with staff ${staffVariantId} to cart...`);
      
      return queueApiCall(async () => {
        const data = await makeBoulevardRequest(ADD_SERVICE_TO_CART_QUERY, {
          cartId,
          itemId: serviceId,
          itemStaffVariantId: staffVariantId
        });
        
        if (!data.addCartSelectedBookableItem?.cart) {
          throw new Error('Failed to add service to cart');
        }
        
        console.log(`‚úÖ Added service to cart successfully`);
        return true;
      });
    }

    // =============================================================================
    // API CALL #5: FETCH AVAILABLE TIMES (ON STAFF CLICK - USER INTERACTION)
    // =============================================================================

    const GET_AVAILABLE_TIMES_QUERY = `
      query GetAvailableTimes($cartId: ID!, $searchDate: String!, $tz: String!) {
        cartBookableTimes(
          id: $cartId,
          searchDate: $searchDate,
          tz: $tz
        ) {
          id
          score
          startTime
        }
      }
    `;

    /**
     * USER INTERACTION: Fetch available times after adding service to cart
     * This is the most "expensive" call and only runs when user clicks staff
     */
    async function fetchAvailableTimes(cartId, date, timezone) {
      console.log(`‚è∞ USER CLICK: Fetching available times for ${date}...`);
      
      return queueApiCall(async () => {
        const data = await makeBoulevardRequest(GET_AVAILABLE_TIMES_QUERY, {
          cartId,
          searchDate: date,
          tz: timezone
        });
        
        const availableTimes = data.cartBookableTimes || [];
        console.log(`‚úÖ Found ${availableTimes.length} available times`);
        
        return availableTimes;
      });
    }

    // =============================================================================
    // INITIAL DASHBOARD LOADING (PAGE LOAD ONLY)
    // =============================================================================

    /**
     * Load initial dashboard data: locations and services only
     * Staff and times are NOT loaded here - they load on user interaction
     */
    async function loadInitialDashboardData() {
      console.log('üöÄ INITIAL LOAD: Loading dashboard data...');
      
      try {
        // Step 1: Get all business locations
        const locations = await fetchBusinessLocations();
        
        // Step 2: For each location, create cart and get services
        const locationData = await Promise.all(
          locations.map(async location => {
            try {
              const { cartId, services } = await createCartAndFetchServices(location.id);
              
              return {
                location,
                cartId,
                services,
                error: null
              };
            } catch (error) {
              console.error(`Failed to load services for ${location.name}:`, error);
              return {
                location,
                cartId: null,
                services: [],
                error: error.message
              };
            }
          })
        );
        
        console.log('‚úÖ Initial dashboard data loaded successfully');
        return { locationData };
        
      } catch (error) {
        console.error('‚ùå Failed to load initial dashboard data:', error);
        throw error;
      }
    }

    // =============================================================================
    // UI RENDERING FUNCTIONS
    // =============================================================================

    /**
     * Render the complete dashboard with locations and services
     * Staff and times will be loaded dynamically on user interaction
     */
    function renderDashboard(data) {
      const container = document.getElementById('dashboard-container');
      
      if (!data.locationData || data.locationData.length === 0) {
        container.innerHTML = `
          <div class="error-state">
            <h3>No Data Found</h3>
            <p>No locations found in your Boulevard business.</p>
            <button onclick="loadAndRenderDashboard()">Retry</button>
          </div>
        `;
        return;
      }
      
      container.innerHTML = '';
      
      data.locationData.forEach(locationInfo => {
        const locationPanel = createLocationPanel(locationInfo);
        container.appendChild(locationPanel);
      });
    }

    /**
     * Create a location panel with services (but no staff/times yet)
     */
    function createLocationPanel(locationInfo) {
      const panel = document.createElement('div');
      panel.className = 'location-panel';
      
      // Location header
      const header = document.createElement('div');
      header.className = 'location-header';
      
      const addressStr = locationInfo.location.address ? 
        `${locationInfo.location.address.city}, ${locationInfo.location.address.state}` : 
        'No address available';
      
      header.innerHTML = `
        <div class="location-name">${locationInfo.location.name}</div>
        <div class="location-address">${addressStr}</div>
        <div class="location-timezone">Timezone: ${locationInfo.location.tz}</div>
      `;
      panel.appendChild(header);
      
      // Handle location errors
      if (locationInfo.error) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-state';
        errorDiv.innerHTML = `
          <h3>Location Error</h3>
          <p>${locationInfo.error}</p>
        `;
        panel.appendChild(errorDiv);
        return panel;
      }
      
      // Services list
      const servicesList = document.createElement('div');
      servicesList.className = 'services-list';
      
      if (!locationInfo.services || locationInfo.services.length === 0) {
        servicesList.innerHTML = `
          <div class="error-state">
            <h3>No Services Available</h3>
            <p>No bookable services found for this location.</p>
          </div>
        `;
      } else {
        locationInfo.services.forEach(service => {
          const serviceElement = createServiceElement(service, locationInfo.cartId, locationInfo.location);
          servicesList.appendChild(serviceElement);
        });
      }
      
      panel.appendChild(servicesList);
      return panel;
    }

    /**
     * Create a service element with click-to-expand functionality
     * Staff will load when user clicks to expand
     */
    function createServiceElement(service, cartId, location) {
      const serviceItem = document.createElement('div');
      serviceItem.className = 'service-item';
      
      // Service header (clickable)
      const serviceHeader = document.createElement('div');
      serviceHeader.className = 'service-header';
      
      const priceText = service.listPrice ? `$${service.listPrice}` : 'Price varies';
      const durationText = service.listDuration ? ` ‚Ä¢ ${service.listDuration} min` : '';
      
      serviceHeader.innerHTML = `
        <div class="service-info">
          <div class="service-name">${service.name}</div>
          <div class="service-description">${service.description || 'No description available'}</div>
          <div class="service-price">${priceText}${durationText}</div>
        </div>
        <div class="expand-indicator">‚ñº</div>
      `;
      
      // Service details container (hidden by default)
      const serviceDetails = document.createElement('div');
      serviceDetails.className = 'service-details';
      
      // Click handler to expand and load staff
      serviceHeader.addEventListener('click', () => {
        toggleServiceExpansion(serviceHeader, serviceDetails, service, cartId, location);
      });
      
      serviceItem.appendChild(serviceHeader);
      serviceItem.appendChild(serviceDetails);
      
      return serviceItem;
    }

    /**
     * USER INTERACTION: Toggle service expansion and load staff if not already loaded
     * This triggers API call #3 (fetch staff variants)
     */
    async function toggleServiceExpansion(header, detailsContainer, service, cartId, location) {
      const isExpanded = header.classList.contains('expanded');
      const indicator = header.querySelector('.expand-indicator');
      
      if (isExpanded) {
        // Collapse
        header.classList.remove('expanded');
        detailsContainer.classList.remove('expanded');
        indicator.classList.remove('expanded');
      } else {
        // Expand
        header.classList.add('expanded');
        detailsContainer.classList.add('expanded');
        indicator.classList.add('expanded');
        
        // Load staff if not already loaded
        if (!detailsContainer.hasChildNodes()) {
          await loadStaffForService(detailsContainer, service, cartId, location);
        }
      }
    }

    /**
     * Load staff variants for a service (triggered by user clicking service)
     * Shows loading spinner while fetching
     */
    async function loadStaffForService(container, service, cartId, location) {
      console.log(`üîÑ LOADING STAFF: User clicked on service ${service.name}`);
      
      // Show loading state
      container.innerHTML = '<div class="staff-loading"><span class="spinner"></span>Loading staff...</div>';
      
      try {
        // API CALL #3: Fetch staff variants for this service
        const staffVariants = await fetchStaffVariants(cartId, service.id);
        
        // Clear loading state and render staff
        container.innerHTML = '';
        
        if (staffVariants.length === 0) {
          container.innerHTML = '<div class="staff-loading">No staff available for this service</div>';
          return;
        }
        
        const staffList = document.createElement('div');
        staffList.className = 'staff-list';
        
        staffVariants.forEach(staffVariant => {
          const staffElement = createStaffElement(staffVariant, service, cartId, location);
          staffList.appendChild(staffElement);
        });
        
        container.appendChild(staffList);
        
      } catch (error) {
        console.error('Failed to load staff:', error);
        container.innerHTML = `<div class="staff-loading">Error loading staff: ${error.message}</div>`;
      }
    }

    /**
     * Create a staff element with click-to-expand functionality
     * Times will load when user clicks to expand
     */
    function createStaffElement(staffVariant, service, cartId, location) {
      const staffItem = document.createElement('div');
      staffItem.className = 'staff-item';
      
      // Staff header (clickable)
      const staffHeader = document.createElement('div');
      staffHeader.className = 'staff-header';
      
      const staffName = staffVariant.staff ? 
        `${staffVariant.staff.firstName} ${staffVariant.staff.lastName}` : 
        'Staff Member';
      
      staffHeader.innerHTML = `
        <div class="staff-info">
          <div class="staff-name">${staffName}</div>
          <div class="staff-details">${staffVariant.duration} minutes</div>
        </div>
        <div class="staff-price">$${staffVariant.price}</div>
      `;
      
      // Times container (hidden by default)
      const timesSection = document.createElement('div');
      timesSection.className = 'times-section';
      
      // Click handler to expand and load times
      staffHeader.addEventListener('click', () => {
        toggleStaffExpansion(staffHeader, timesSection, staffVariant, service, cartId, location);
      });
      
      staffItem.appendChild(staffHeader);
      staffItem.appendChild(timesSection);
      
      return staffItem;
    }

    /**
     * USER INTERACTION: Toggle staff expansion and load times if not already loaded
     * This triggers API calls #4 and #5 (add to cart + fetch times)
     */
    async function toggleStaffExpansion(header, timesContainer, staffVariant, service, cartId, location) {
      const isExpanded = header.classList.contains('expanded');
      
      if (isExpanded) {
        // Collapse
        header.classList.remove('expanded');
        timesContainer.classList.remove('expanded');
      } else {
        // Expand
        header.classList.add('expanded');
        timesContainer.classList.add('expanded');
        
        // Load times if not already loaded
        if (!timesContainer.hasChildNodes()) {
          await loadTimesForStaff(timesContainer, staffVariant, service, cartId, location);
        }
      }
    }

    /**
     * Load available times for staff (triggered by user clicking staff)
     * This is the most expensive operation and only runs on user demand
     */
    async function loadTimesForStaff(container, staffVariant, service, cartId, location) {
      const staffName = staffVariant.staff ? 
        `${staffVariant.staff.firstName} ${staffVariant.staff.lastName}` : 
        'staff member';
      
      console.log(`üîÑ LOADING TIMES: User clicked on ${staffName} for ${service.name}`);
      
      // Show loading state
      container.innerHTML = '<div class="times-loading"><span class="spinner"></span>Loading available times...</div>';
      
      try {
        // API CALL #4: Add service/staff to cart first
        await addServiceToCart(cartId, service.id, staffVariant.id);
        
        // API CALL #5: Fetch available times for selected date
        const dateStr = currentDate.toISOString().split('T')[0];
        const availableTimes = await fetchAvailableTimes(cartId, dateStr, location.tz);
        
        // Clear loading state and render times
        container.innerHTML = '';
        
        if (availableTimes.length === 0) {
          container.innerHTML = '<div class="no-times">No available times for this date</div>';
          return;
        }
        
        const timesGrid = document.createElement('div');
        timesGrid.className = 'times-grid';
        
        availableTimes.forEach(timeSlot => {
          const timeElement = document.createElement('div');
          timeElement.className = 'time-slot';
          
          // Format the time for display
          const timeStr = new Date(`2000-01-01T${timeSlot.startTime}`).toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          });
          
          timeElement.textContent = timeStr;
          
          // Click handler for time selection (demo only)
          timeElement.addEventListener('click', () => {
            alert(`Selected ${timeStr} with ${staffName} for ${service.name}!\n\nIn a real app, this would proceed to booking confirmation.`);
          });
          
          timesGrid.appendChild(timeElement);
        });
        
        container.appendChild(timesGrid);
        
      } catch (error) {
        console.error('Failed to load times:', error);
        container.innerHTML = `<div class="times-loading">Error loading times: ${error.message}</div>`;
      }
    }

    // =============================================================================
    // DATE NAVIGATION AND UTILITIES
    // =============================================================================

    function updateDateDisplay() {
      const dateElement = document.getElementById('currentDate');
      const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      };
      dateElement.textContent = currentDate.toLocaleDateString('en-US', options);
    }

    /**
     * Main function to load and render the dashboard
     * Only loads locations and services - staff/times load on demand
     */
    async function loadAndRenderDashboard() {
      console.log('üöÄ Initializing fast-loading dashboard...');
      
      const container = document.getElementById('dashboard-container');
      container.innerHTML = '<div class="loading-state">Loading business locations and services...</div>';
      
      try {
        dashboardData = await loadInitialDashboardData();
        renderDashboard(dashboardData);
      } catch (error) {
        console.error('‚ùå Failed to load dashboard:', error);
        container.innerHTML = `
          <div class="error-state">
            <h3>Error Loading Dashboard</h3>
            <p>${error.message}</p>
            <p>Please check your Boulevard configuration and API key.</p>
            <button onclick="loadAndRenderDashboard()">Retry</button>
          </div>
        `;
      }
    }

    /**
     * Test function to verify API connectivity
     */
    async function testBoulevardAPI() {
      console.log('üß™ Testing Boulevard Client API...');
      
      try {
        const locations = await fetchBusinessLocations();
        console.log(`‚úÖ API Test Successful: Found ${locations.length} locations`);
        alert(`API Test Successful!\n\nFound ${locations.length} business locations.\nCheck console for detailed logs.`);
      } catch (error) {
        console.error('üí• API Test Failed:', error);
        alert(`API Test Failed!\n\nError: ${error.message}\nCheck console for details.`);
      }
    }

    // =============================================================================
    // EVENT LISTENERS AND INITIALIZATION
    // =============================================================================

    document.addEventListener('DOMContentLoaded', function() {
      console.log('üì± Dashboard loading with smart lazy-loading...');
      
      updateDateDisplay();
      loadAndRenderDashboard();
      
      // Date navigation - reloads data when date changes
      document.getElementById('prevDay').addEventListener('click', () => {
        currentDate.setDate(currentDate.getDate() - 1);
        updateDateDisplay();
        // Note: Expanded staff/times will need to reload for new date
        // For simplicity, we reload the entire dashboard
        loadAndRenderDashboard();
      });
      
      document.getElementById('nextDay').addEventListener('click', () => {
        currentDate.setDate(currentDate.getDate() + 1);
        updateDateDisplay();
        // Note: Expanded staff/times will need to reload for new date
        // For simplicity, we reload the entire dashboard
        loadAndRenderDashboard();
      });
      
      // Test API button
      document.getElementById('testAPI').addEventListener('click', testBoulevardAPI);
    });

    // Export for debugging
    window.boulevardDashboard = {
      testAPI: testBoulevardAPI,
      loadAndRenderDashboard,
      makeBoulevardRequest,
      fetchBusinessLocations,
      createCartAndFetchServices,
      fetchStaffVariants,
      addServiceToCart,
      fetchAvailableTimes
    };

    console.log('‚úÖ Fast-loading Boulevard dashboard initialized');
    console.log('üìã Data Loading Strategy:');
    console.log('  - Locations & Services: Load immediately (fast)');
    console.log('  - Staff: Load only when user clicks service (on-demand)');
    console.log('  - Times: Load only when user clicks staff (on-demand)');
    console.log('üöÄ This prevents rate limits and ensures blazing fast performance!');
  </script>
</body>
</html>
