<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Get Plump - Global Appointment Dashboard</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      min-height: 100vh;
    }
    
    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .dashboard-header {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .dashboard-title {
      font-size: 28px;
      font-weight: 700;
      color: #1a1a1a;
    }
    
    .date-navigation {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .nav-button {
      background: #007AFF;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .nav-button:hover {
      background: #0056d6;
      transform: translateY(-1px);
    }
    
    .current-date {
      font-size: 18px;
      font-weight: 600;
      color: #1a1a1a;
      min-width: 200px;
      text-align: center;
    }
    
    .filters-container {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    
    .filter-dropdown {
      background: #fff;
      border: 2px solid #e5e5e7;
      border-radius: 8px;
      padding: 10px 16px;
      cursor: pointer;
      min-width: 160px;
      font-weight: 500;
      position: relative;
    }
    
    .filter-dropdown:hover {
      border-color: #007AFF;
    }
    
    .dropdown-content {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 2px solid #e5e5e7;
      border-radius: 8px;
      margin-top: 4px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    
    .dropdown-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f5f5f5;
    }
    
    .dropdown-item:hover {
      background: #f8f9fa;
    }
    
    .refresh-button {
      background: #007AFF;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .refresh-button:hover {
      background: #0056d6;
    }
    
    .test-button {
      background: #34c759;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 500;
      margin-left: 8px;
    }
    
    .test-button:hover {
      background: #30a752;
    }
    
    .legend {
      display: flex;
      gap: 20px;
      margin-bottom: 16px;
      font-size: 14px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    
    .status-dot.available { background: #51cf66; }
    .status-dot.booked { background: #ff6b6b; }
    .status-dot.off-shift { background: #868e96; }
    
    .dashboard-content {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .locations-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 1px;
      background: #e5e5e7;
    }
    
    .location-panel {
      background: #fff;
      padding: 24px;
      min-height: 600px;
    }
    
    .location-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #f5f5f5;
    }
    
    .location-name {
      font-size: 20px;
      font-weight: 700;
      color: #1a1a1a;
    }
    
    .location-stats {
      display: flex;
      gap: 16px;
      font-size: 14px;
      color: #666;
    }
    
    .stat-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .business-hours {
      font-size: 12px;
      color: #888;
      margin-bottom: 16px;
    }
    
    .staff-section {
      margin-bottom: 20px;
      border: 1px solid #f0f0f0;
      border-radius: 8px;
      padding: 16px;
    }
    
    .staff-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .staff-header.working {
      background: #e8f5e8;
      padding: 8px;
      border-radius: 6px;
    }
    
    .staff-header.not-working {
      background: #f5f5f5;
      padding: 8px;
      border-radius: 6px;
      opacity: 0.7;
    }
    
    .staff-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #007AFF;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
    }
    
    .staff-info {
      flex: 1;
    }
    
    .staff-name {
      font-size: 16px;
      font-weight: 600;
      color: #1a1a1a;
    }
    
    .staff-role {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }
    
    .staff-shift {
      font-size: 12px;
      color: #007AFF;
      font-weight: 500;
      margin-top: 4px;
    }
    
    .appointments-list {
      margin-top: 12px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
    }
    
    .appointment-item {
      padding: 4px 0;
      font-size: 13px;
      color: #333;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .appointment-item:last-child {
      border-bottom: none;
    }
    
    .loading-state {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 400px;
      color: #666;
      font-size: 18px;
    }
    
    .error-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 400px;
      color: #d32f2f;
      text-align: center;
      padding: 20px;
    }
    
    .error-state h3 {
      margin-bottom: 12px;
      font-size: 20px;
    }
    
    .error-state p {
      margin-bottom: 8px;
      color: #666;
    }
    
    .error-state button {
      margin-top: 16px;
      background: #007AFF;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .no-data-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 400px;
      color: #666;
      text-align: center;
      padding: 20px;
    }
    
    .no-data-state h3 {
      margin-bottom: 12px;
      font-size: 20px;
      color: #1a1a1a;
    }
    
    .no-data-state p {
      margin-bottom: 8px;
    }
    
    .no-data-state button {
      margin-top: 16px;
      background: #007AFF;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .no-staff {
      text-align: center;
      color: #666;
      padding: 20px;
      font-style: italic;
    }
    
    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .dashboard-container {
        padding: 10px;
      }
      
      .header-top {
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
      }
      
      .date-navigation {
        justify-content: center;
      }
      
      .filters-container {
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .locations-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="dashboard-header">
      <div class="header-top">
        <h1 class="dashboard-title">Get Plump - Global Appointment Dashboard</h1>
        
        <div class="date-navigation">
          <button class="nav-button" id="prevDay">← Previous</button>
          <div class="current-date" id="currentDate">Today</div>
          <button class="nav-button" id="nextDay">Next →</button>
        </div>
      </div>
      
      <div class="filters-container">
        <div class="filter-dropdown" id="locationFilter">
          All Locations ▼
          <div class="dropdown-content" id="locationDropdown">
            <div class="dropdown-item" data-location="all">All Locations</div>
          </div>
        </div>
        
        <div class="filter-dropdown" id="staffFilter">
          All Staff ▼
          <div class="dropdown-content" id="staffDropdown">
            <div class="dropdown-item" data-staff="all">All Staff</div>
          </div>
        </div>
        
        <button class="refresh-button" id="refreshData">Refresh</button>
        <button class="test-button" id="testAPI">Test API</button>
      </div>
      
      <div class="legend">
        <div class="legend-item">
          <div class="legend-dot status-dot available"></div>
          <span>Available</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot status-dot booked"></div>
          <span>Booked</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot status-dot off-shift"></div>
          <span>Off Shift</span>
        </div>
      </div>
    </div>
    
    <div class="dashboard-content">
      <div id="dashboard-container" class="locations-grid">
        <div class="loading-state">
          Loading real Boulevard data...
        </div>
      </div>
    </div>
  </div>

  <script>
    // =============================================================================
    // BOULEVARD ADMIN API - CORRECTED QUERIES WITH URNS
    // =============================================================================

    // Global State
    let currentDate = new Date();
    let selectedLocation = 'all';
    let selectedStaff = 'all';
    let dashboardData = null;

    // Helper function to ensure IDs are in URN format
    function ensureURN(id, type) {
      if (!id) return null;
      
      // If already a URN, return as-is
      if (id.startsWith('urn:blvd:')) {
        return id;
      }
      
      // Convert UUID to URN
      return `urn:blvd:${type}:${id}`;
    }

    // API Helper Function
    async function queryBoulevard(query, variables = {}) {
      console.log('🔥 Making Boulevard API request...');
      console.log('Query:', query.substring(0, 200) + '...');
      console.log('Variables:', variables);
      
      const response = await fetch('/api/blvd', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          query: query,
          variables: variables
        })
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('API Error Response:', errorText);
        throw new Error(`API request failed: ${response.status} - ${errorText}`);
      }
      
      const data = await response.json();
      
      if (data.errors && data.errors.length > 0) {
        console.error('GraphQL errors:', data.errors);
        throw new Error(`GraphQL Error: ${data.errors[0].message}`);
      }
      
      return data.data;
    }

    // =============================================================================
    // 1. FETCH ALL LOCATIONS (ROOT QUERY) - CORRECTED
    // =============================================================================

    const LOCATIONS_QUERY = `
      query GetAllLocations($first: Int!) {
        locations(first: $first) {
          edges {
            node {
              id
              name
              businessName
              tz
              businessHours {
                day
                startTime
                endTime
                isClosed
              }
              isActive
            }
          }
          pageInfo {
            hasNextPage
            endCursor
          }
        }
      }
    `;

    async function fetchAllLocations() {
      console.log('🏢 Fetching all locations...');
      
      try {
        const data = await queryBoulevard(LOCATIONS_QUERY, { first: 50 });
        
        if (!data.locations || !data.locations.edges) {
          console.log('⚠️ No locations data returned');
          return [];
        }
        
        const locations = data.locations.edges
          .map(edge => edge.node)
          .filter(location => location.isActive);
        
        console.log(`✅ Found ${locations.length} active locations`);
        locations.forEach(l => {
          console.log(`  - ${l.name} (${l.businessName}) - ID: ${l.id}`);
        });
        
        return locations;
        
      } catch (error) {
        console.error('❌ Failed to fetch locations:', error);
        return [];
      }
    }

    // =============================================================================
    // 2. FETCH ALL STAFF USING LOCATION-BASED APPROACH - CORRECTED
    // =============================================================================

    const LOCATION_STAFF_QUERY = `
      query GetLocationStaff($id: ID!) {
        location(id: $id) {
          id
          name
          staff {
            id
            firstName
            lastName
            email
            active
            role {
              id
              name
            }
          }
        }
      }
    `;

    async function fetchAllStaff(locations) {
      console.log('🔍 Fetching all staff from all locations...');
      
      try {
        const staffMap = new Map();
        
        // For each location, get staff
        for (const location of locations) {
          console.log(`Getting staff for location: ${location.name}`);
          
          // Ensure location ID is in URN format
          const locationIdURN = ensureURN(location.id, 'Location');
          
          const data = await queryBoulevard(LOCATION_STAFF_QUERY, { 
            id: locationIdURN 
          });
          
          if (data.location && data.location.staff) {
            data.location.staff.forEach(staff => {
              if (staff.active) {
                if (!staffMap.has(staff.id)) {
                  staffMap.set(staff.id, {
                    ...staff,
                    locations: [location]
                  });
                } else {
                  // Add this location to existing staff member
                  const existingStaff = staffMap.get(staff.id);
                  existingStaff.locations.push(location);
                }
              }
            });
          }
        }
        
        const allStaff = Array.from(staffMap.values());
        
        console.log(`✅ Found ${allStaff.length} active staff members across all locations`);
        allStaff.forEach(s => {
          console.log(`  - ${s.firstName} ${s.lastName} (${s.role?.name || 'No role'}) - Locations: ${s.locations.map(l => l.name).join(', ')}`);
        });
        
        return allStaff;
        
      } catch (error) {
        console.error('❌ Failed to fetch staff:', error);
        return [];
      }
    }

    // =============================================================================
    // 3. FETCH SHIFTS FOR LOCATION AND DATE - CORRECTED WITH URNS
    // =============================================================================

    const SHIFTS_QUERY = `
      query GetLocationShifts($locationId: ID!, $startIso8601: DateTime!, $endIso8601: DateTime!, $first: Int!) {
        shifts(
          locationId: $locationId,
          startIso8601: $startIso8601,
          endIso8601: $endIso8601,
          first: $first
        ) {
          edges {
            node {
              id
              staffId
              locationId
              date
              startTime
              endTime
              available
              staff {
                id
                firstName
                lastName
              }
              location {
                id
                name
              }
            }
          }
        }
      }
    `;

    async function fetchShifts(locationId, date) {
      console.log(`📅 Fetching shifts for location ${locationId} on ${date.toISOString().split('T')[0]}...`);
      
      try {
        // Ensure location ID is in URN format
        const locationIdURN = ensureURN(locationId, 'Location');
        
        // Create start and end of day in ISO format
        const startOfDay = new Date(date);
        startOfDay.setHours(0, 0, 0, 0);
        const endOfDay = new Date(date);
        endOfDay.setHours(23, 59, 59, 999);
        
        const data = await queryBoulevard(SHIFTS_QUERY, {
          locationId: locationIdURN,
          startIso8601: startOfDay.toISOString(),
          endIso8601: endOfDay.toISOString(),
          first: 100
        });
        
        if (!data.shifts || !data.shifts.edges) {
          console.log(`⚠️ No shifts found for location ${locationId}`);
          return [];
        }
        
        const shifts = data.shifts.edges.map(edge => edge.node);
        
        console.log(`✅ Found ${shifts.length} shifts for location`);
        shifts.forEach(shift => {
          const staffName = shift.staff ? `${shift.staff.firstName} ${shift.staff.lastName}` : 'Unknown Staff';
          console.log(`  - ${staffName}: ${shift.startTime} - ${shift.endTime} (Available: ${shift.available})`);
        });
        
        return shifts;
        
      } catch (error) {
        console.error(`❌ Failed to fetch shifts for location ${locationId}:`, error);
        return [];
      }
    }

    // =============================================================================
    // 4. FETCH APPOINTMENTS FOR LOCATION AND DATE - CORRECTED WITH URNS
    // =============================================================================

    const APPOINTMENTS_QUERY = `
      query GetLocationAppointments($locationId: ID!, $after: DateTime!, $before: DateTime!, $first: Int!) {
        appointments(
          locationId: $locationId,
          after: $after,
          before: $before,
          first: $first
        ) {
          edges {
            node {
              id
              startAt
              endAt
              state
              cancelled
              client {
                id
                firstName
                lastName
              }
              staff {
                id
                firstName
                lastName
              }
              location {
                id
                name
              }
              appointmentServices {
                id
                startAt
                endAt
                duration
                service {
                  name
                  category {
                    name
                  }
                }
                staff {
                  id
                  firstName
                  lastName
                }
              }
            }
          }
        }
      }
    `;

    async function fetchAppointments(locationId, date) {
      console.log(`📋 Fetching appointments for location ${locationId} on ${date.toISOString().split('T')[0]}...`);
      
      try {
        // Ensure location ID is in URN format
        const locationIdURN = ensureURN(locationId, 'Location');
        
        const startOfDay = new Date(date);
        startOfDay.setHours(0, 0, 0, 0);
        const endOfDay = new Date(date);
        endOfDay.setHours(23, 59, 59, 999);
        
        const data = await queryBoulevard(APPOINTMENTS_QUERY, {
          locationId: locationIdURN,
          after: startOfDay.toISOString(),
          before: endOfDay.toISOString(),
          first: 100
        });
        
        if (!data.appointments || !data.appointments.edges) {
          console.log(`⚠️ No appointments found for location ${locationId}`);
          return [];
        }
        
        const appointments = data.appointments.edges
          .map(edge => edge.node)
          .filter(apt => !apt.cancelled); // Filter out cancelled appointments
        
        console.log(`✅ Found ${appointments.length} active appointments`);
        appointments.forEach(apt => {
          const clientName = apt.client ? `${apt.client.firstName} ${apt.client.lastName}` : 'No Client';
          const staffName = apt.staff ? `${apt.staff.firstName} ${apt.staff.lastName}` : 'No Staff';
          const startTime = new Date(apt.startAt).toLocaleTimeString('en-US', { 
            hour: 'numeric', 
            minute: '2-digit',
            hour12: true 
          });
          console.log(`  - ${startTime}: ${clientName} with ${staffName}`);
        });
        
        return appointments;
        
      } catch (error) {
        console.error(`❌ Failed to fetch appointments for location ${locationId}:`, error);
        return [];
      }
    }

    // =============================================================================
    // 5. ALTERNATIVE: TRY ROOT STAFFMEMBERS QUERY (IF IT EXISTS)
    // =============================================================================

    const STAFFMEMBERS_QUERY = `
      query GetAllStaffMembers($first: Int!) {
        staffMembers(first: $first) {
          edges {
            node {
              id
              firstName
              lastName
              email
              active
              role {
                id
                name
              }
              locations {
                id
                name
              }
            }
          }
          pageInfo {
            hasNextPage
            endCursor
          }
        }
      }
    `;

    async function fetchAllStaffAlternative() {
      console.log('🔍 Trying alternative staffMembers query...');
      
      try {
        const data = await queryBoulevard(STAFFMEMBERS_QUERY, { first: 100 });
        
        if (!data.staffMembers || !data.staffMembers.edges) {
          console.log('⚠️ No staffMembers data returned (query may not exist)');
          return null;
        }
        
        const staff = data.staffMembers.edges
          .map(edge => edge.node)
          .filter(staff => staff.active);
        
        console.log(`✅ Found ${staff.length} active staff members via staffMembers query`);
        return staff;
        
      } catch (error) {
        console.error('❌ staffMembers query failed (probably not available):', error);
        return null;
      }
    }

    // =============================================================================
    // 6. COMPLETE DASHBOARD DATA LOADING - CORRECTED
    // =============================================================================

    async function loadDashboardData(selectedDate) {
      console.log(`🔄 Loading complete dashboard data for ${selectedDate.toISOString().split('T')[0]}...`);
      
      try {
        // Step 1: Load all locations first
        const allLocations = await fetchAllLocations();
        
        if (allLocations.length === 0) {
          console.error('❌ No locations found - check your Boulevard account setup');
          return { error: 'No locations found in Boulevard account' };
        }
        
        // Step 2: Try to load staff using alternative method first, then fallback
        let allStaff = await fetchAllStaffAlternative();
        
        if (!allStaff) {
          console.log('📋 Falling back to location-based staff fetching...');
          allStaff = await fetchAllStaff(allLocations);
        }
        
        if (allStaff.length === 0) {
          console.error('❌ No staff found - check your Boulevard account setup');
          return { error: 'No staff found in Boulevard account' };
        }
        
        // Filter locations if needed
        const locationsToShow = selectedLocation === 'all' ? 
          allLocations : 
          allLocations.filter(loc => loc.name === selectedLocation);
        
        // Step 3: For each location, load shifts and appointments
        const locationData = await Promise.all(
          locationsToShow.map(async location => {
            console.log(`🏢 Processing location: ${location.name}...`);
            
            const [shifts, appointments] = await Promise.all([
              fetchShifts(location.id, selectedDate),
              fetchAppointments(location.id, selectedDate)
            ]);
            
            // Step 4: Find staff working at this location
            const locationStaff = allStaff.filter(staff => 
              staff.locations && staff.locations.some(loc => 
                loc.id === location.id || 
                ensureURN(loc.id, 'Location') === ensureURN(location.id, 'Location')
              )
            );
            
            // Step 5: Map shifts to staff
            const staffWithShifts = locationStaff.map(staff => {
              const staffShift = shifts.find(shift => 
                shift.staffId === staff.id || 
                ensureURN(shift.staffId, 'Staff') === ensureURN(staff.id, 'Staff')
              );
              return {
                ...staff,
                shift: staffShift || null,
                isWorking: !!staffShift && staffShift.available
              };
            });
            
            // Filter staff if needed
            const staffToShow = selectedStaff === 'all' ? 
              staffWithShifts : 
              staffWithShifts.filter(staff => staff.id === selectedStaff);
            
            console.log(`✅ ${location.name}: ${staffToShow.length} staff, ${shifts.length} shifts, ${appointments.length} appointments`);
            
            return {
              location: location,
              staff: staffToShow,
              shifts: shifts,
              appointments: appointments
            };
          })
        );
        
        console.log('✅ Dashboard data loaded successfully');
        
        return {
          allStaff: allStaff,
          allLocations: allLocations,
          locationData: locationData
        };
        
      } catch (error) {
        console.error('❌ Failed to load dashboard data:', error);
        return { error: error.message };
      }
    }

    // =============================================================================
    // 7. TEST FUNCTION TO DEBUG API ISSUES
    // =============================================================================

    async function testBoulevardAPI() {
      console.log('🧪 Testing Boulevard API endpoints...');
      
      try {
        // Test 1: Locations
        console.log('Test 1: Fetching locations...');
        const locations = await fetchAllLocations();
        console.log(`✅ Locations test: ${locations.length} found`);
        
        if (locations.length > 0) {
          const firstLocation = locations[0];
          console.log(`First location: ${firstLocation.name} (${firstLocation.id})`);
          
          // Test 2: Staff for first location
          console.log('Test 2: Fetching staff for first location...');
          const staff = await fetchAllStaff([firstLocation]);
          console.log(`✅ Staff test: ${staff.length} found`);
          
          // Test 3: Shifts for first location
          console.log('Test 3: Fetching shifts for first location...');
          const shifts = await fetchShifts(firstLocation.id, new Date());
          console.log(`✅ Shifts test: ${shifts.length} found`);
          
          // Test 4: Appointments for first location
          console.log('Test 4: Fetching appointments for first location...');
          const appointments = await fetchAppointments(firstLocation.id, new Date());
          console.log(`✅ Appointments test: ${appointments.length} found`);
        }
        
        console.log('🎉 All API tests completed successfully!');
        
      } catch (error) {
        console.error('💥 API test failed:', error);
        throw error;
      }
    }

    // =============================================================================
    // 8. RENDER DASHBOARD WITH REAL DATA
    // =============================================================================

    function renderDashboard(data) {
      const container = document.getElementById('dashboard-container');
      
      if (data.error) {
        container.innerHTML = `
          <div class="error-state">
            <h3>Error Loading Data</h3>
            <p>${data.error}</p>
            <button onclick="loadAndRenderDashboard()">Retry</button>
          </div>
        `;
        return;
      }
      
      if (!data.locationData || data.locationData.length === 0) {
        container.innerHTML = `
          <div class="no-data-state">
            <h3>No Data Found</h3>
            <p>No locations or staff found in your Boulevard account.</p>
            <p>Please check your Boulevard setup and try again.</p>
            <button onclick="loadAndRenderDashboard()">Retry</button>
          </div>
        `;
        return;
      }
      
      // Clear container
      container.innerHTML = '';
      
      // Render each location
      data.locationData.forEach(locationInfo => {
        const locationPanel = createLocationPanel(locationInfo);
        container.appendChild(locationPanel);
      });
    }

    function createLocationPanel(locationInfo) {
      const panel = document.createElement('div');
      panel.className = 'location-panel';
      
      // Location header
      const header = document.createElement('div');
      header.className = 'location-header';
      header.innerHTML = `
        <div>
          <div class="location-name">${locationInfo.location.name}</div>
          <div class="business-hours">Business: ${locationInfo.location.businessName || 'N/A'}</div>
        </div>
        <div class="location-stats">
          <div class="stat-item">
            <span>${locationInfo.staff.length} staff</span>
          </div>
          <div class="stat-item">
            <span>${locationInfo.shifts.length} shifts</span>
          </div>
          <div class="stat-item">
            <span>${locationInfo.appointments.length} appointments</span>
          </div>
        </div>
      `;
      panel.appendChild(header);
      
      // Staff list
      if (locationInfo.staff.length === 0) {
        const noStaff = document.createElement('div');
        noStaff.className = 'no-staff';
        noStaff.textContent = 'No staff assigned to this location';
        panel.appendChild(noStaff);
      } else {
        locationInfo.staff.forEach(staff => {
          const staffSection = createStaffSection(staff, locationInfo.appointments);
          panel.appendChild(staffSection);
        });
      }
      
      return panel;
    }

    function createStaffSection(staff, appointments) {
      const section = document.createElement('div');
      section.className = 'staff-section';
      
      const shiftInfo = staff.shift ? 
        `${staff.shift.startTime} - ${staff.shift.endTime}` : 
        'Not scheduled';
        
      const workingStatus = staff.isWorking ? 'working' : 'not-working';
      
      // Staff header
      const header = document.createElement('div');
      header.className = `staff-header ${workingStatus}`;
      
      const avatar = document.createElement('div');
      avatar.className = 'staff-avatar';
      avatar.textContent = `${staff.firstName.charAt(0)}${staff.lastName.charAt(0)}`;
      
      const staffInfo = document.createElement('div');
      staffInfo.className = 'staff-info';
      
      const staffName = document.createElement('div');
      staffName.className = 'staff-name';
      staffName.textContent = `${staff.firstName} ${staff.lastName}`;
      
      const staffRole = document.createElement('div');
      staffRole.className = 'staff-role';
      staffRole.textContent = staff.role?.name || 'No role assigned';
      
      const staffShift = document.createElement('div');
      staffShift.className = 'staff-shift';
      staffShift.textContent = shiftInfo;
      
      staffInfo.appendChild(staffName);
      staffInfo.appendChild(staffRole);
      staffInfo.appendChild(staffShift);
      
      header.appendChild(avatar);
      header.appendChild(staffInfo);
      section.appendChild(header);
      
      // Add appointment details if staff is working
      if (staff.isWorking) {
        const staffAppointments = appointments.filter(apt => 
          apt.staff && apt.staff.id === staff.id ||
          apt.appointmentServices.some(service => 
            service.staff && service.staff.id === staff.id
          )
        );
        
        if (staffAppointments.length > 0) {
          const appointmentsList = document.createElement('div');
          appointmentsList.className = 'appointments-list';
          
          staffAppointments.forEach(apt => {
            const startTime = new Date(apt.startAt).toLocaleTimeString('en-US', {
              hour: 'numeric',
              minute: '2-digit',
              hour12: true
            });
            
            const clientName = apt.client ? 
              `${apt.client.firstName} ${apt.client.lastName}` : 
              'Client';
              
            const appointmentItem = document.createElement('div');
            appointmentItem.className = 'appointment-item';
            appointmentItem.textContent = `${startTime} - ${clientName}`;
            appointmentsList.appendChild(appointmentItem);
          });
          
          section.appendChild(appointmentsList);
        } else {
          const noAppointments = document.createElement('div');
          noAppointments.className = 'appointments-list';
          noAppointments.innerHTML = '<div class="appointment-item">No appointments scheduled</div>';
          section.appendChild(noAppointments);
        }
      }
      
      return section;
    }

    // =============================================================================
    // 9. POPULATE FILTER DROPDOWNS
    // =============================================================================

    function populateLocationFilter(locations) {
      const dropdown = document.getElementById('locationDropdown');
      dropdown.innerHTML = '<div class="dropdown-item" data-location="all">All Locations</div>';
      
      locations.forEach(location => {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        item.setAttribute('data-location', location.name);
        item.textContent = location.name;
        dropdown.appendChild(item);
      });
    }

    function populateStaffFilter(staff) {
      const dropdown = document.getElementById('staffDropdown');
      dropdown.innerHTML = '<div class="dropdown-item" data-staff="all">All Staff</div>';
      
      staff.forEach(member => {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        item.setAttribute('data-staff', member.id);
        item.textContent = `${member.firstName} ${member.lastName} (${member.locations.map(l => l.name).join(', ')})`;
        dropdown.appendChild(item);
      });
    }

    // =============================================================================
    // 10. UPDATE DATE DISPLAY
    // =============================================================================

    function updateDateDisplay() {
      const dateElement = document.getElementById('currentDate');
      const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      };
      dateElement.textContent = currentDate.toLocaleDateString('en-US', options);
    }

    // =============================================================================
    // 11. MAIN INITIALIZATION FUNCTION
    // =============================================================================

    async function loadAndRenderDashboard() {
      console.log('🚀 Initializing Boulevard Dashboard...');
      
      // Show loading state
      const container = document.getElementById('dashboard-container');
      container.innerHTML = '<div class="loading-state">Loading real Boulevard data...</div>';
      
      // Load and render data
      dashboardData = await loadDashboardData(currentDate);
      
      // Populate filters if we have data
      if (dashboardData && !dashboardData.error) {
        populateLocationFilter(dashboardData.allLocations);
        populateStaffFilter(dashboardData.allStaff);
      }
      
      renderDashboard(dashboardData);
    }

    // =============================================================================
    // 12. EVENT LISTENERS
    // =============================================================================

    document.addEventListener('DOMContentLoaded', function() {
      console.log('📱 Page loaded, starting Boulevard dashboard...');
      
      // Initialize date display
      updateDateDisplay();
      
      // Load initial data
      loadAndRenderDashboard();
      
      // Date navigation
      document.getElementById('prevDay').addEventListener('click', () => {
        currentDate.setDate(currentDate.getDate() - 1);
        updateDateDisplay();
        loadAndRenderDashboard();
      });
      
      document.getElementById('nextDay').addEventListener('click', () => {
        currentDate.setDate(currentDate.getDate() + 1);
        updateDateDisplay();
        loadAndRenderDashboard();
      });
      
      // Location filter
      document.getElementById('locationFilter').addEventListener('click', () => {
        const dropdown = document.getElementById('locationDropdown');
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
      });
      
      document.getElementById('locationDropdown').addEventListener('click', (e) => {
        if (e.target.classList.contains('dropdown-item')) {
          selectedLocation = e.target.getAttribute('data-location');
          document.getElementById('locationFilter').textContent = e.target.textContent + ' ▼';
          document.getElementById('locationDropdown').style.display = 'none';
          loadAndRenderDashboard();
        }
      });
      
      // Staff filter
      document.getElementById('staffFilter').addEventListener('click', () => {
        const dropdown = document.getElementById('staffDropdown');
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
      });
      
      document.getElementById('staffDropdown').addEventListener('click', (e) => {
        if (e.target.classList.contains('dropdown-item')) {
          selectedStaff = e.target.getAttribute('data-staff');
          document.getElementById('staffFilter').textContent = e.target.textContent + ' ▼';
          document.getElementById('staffDropdown').style.display = 'none';
          loadAndRenderDashboard();
        }
      });
      
      // Refresh button
      document.getElementById('refreshData').addEventListener('click', () => {
        loadAndRenderDashboard();
      });
      
      // Test API button
      document.getElementById('testAPI').addEventListener('click', () => {
        testBoulevardAPI();
      });
      
      // Close dropdowns when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.filter-dropdown')) {
          document.querySelectorAll('.dropdown-content').forEach(dropdown => {
            dropdown.style.display = 'none';
          });
        }
      });
    });

    // Export functions for manual testing
    window.boulevardAPI = {
      fetchAllLocations,
      fetchAllStaff,
      fetchAllStaffAlternative,
      fetchShifts,
      fetchAppointments,
      loadDashboardData,
      testBoulevardAPI,
      ensureURN,
      queryBoulevard
    };

    console.log('✅ Boulevard API functions loaded with URN support');
    console.log('🧪 Run window.boulevardAPI.testBoulevardAPI() to test your API connection');
  </script>
</body>
</html>
