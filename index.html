<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Get Plump - Service Availability Dashboard</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      min-height: 100vh;
    }
    
    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .dashboard-header {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .dashboard-title {
      font-size: 28px;
      font-weight: 700;
      color: #1a1a1a;
    }
    
    .date-navigation {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .nav-button {
      background: #007AFF;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .nav-button:hover {
      background: #0056d6;
      transform: translateY(-1px);
    }
    
    .current-date {
      font-size: 18px;
      font-weight: 600;
      color: #1a1a1a;
      min-width: 200px;
      text-align: center;
    }
    
    .filters-container {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .filter-dropdown {
      background: #fff;
      border: 2px solid #e5e5e7;
      border-radius: 8px;
      padding: 10px 16px;
      cursor: pointer;
      min-width: 160px;
      font-weight: 500;
      position: relative;
    }
    
    .filter-dropdown:hover {
      border-color: #007AFF;
    }
    
    .dropdown-content {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 2px solid #e5e5e7;
      border-radius: 8px;
      margin-top: 4px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    
    .dropdown-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f5f5f5;
    }
    
    .dropdown-item:hover {
      background: #f8f9fa;
    }
    
    .refresh-button, .test-button {
      background: #007AFF;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 500;
      margin-left: 8px;
    }
    
    .test-button {
      background: #34c759;
    }
    
    .refresh-button:hover {
      background: #0056d6;
    }
    
    .test-button:hover {
      background: #30a752;
    }
    
    .legend {
      display: flex;
      gap: 20px;
      margin-bottom: 16px;
      font-size: 14px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    
    .status-dot.available { background: #51cf66; }
    .status-dot.busy { background: #ff6b6b; }
    .status-dot.no-service { background: #868e96; }
    
    .dashboard-content {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .locations-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 1px;
      background: #e5e5e7;
    }
    
    .location-panel {
      background: #fff;
      padding: 24px;
      min-height: 600px;
    }
    
    .location-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #f5f5f5;
    }
    
    .location-name {
      font-size: 20px;
      font-weight: 700;
      color: #1a1a1a;
    }
    
    .location-stats {
      display: flex;
      gap: 16px;
      font-size: 14px;
      color: #666;
    }
    
    .stat-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .location-address {
      font-size: 12px;
      color: #888;
      margin-bottom: 16px;
    }
    
    .service-section {
      margin-bottom: 20px;
      border: 1px solid #f0f0f0;
      border-radius: 8px;
      padding: 16px;
    }
    
    .service-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      cursor: pointer;
    }
    
    .service-header:hover {
      background: #f8f9fa;
      padding: 8px;
      border-radius: 6px;
      margin: -8px -8px 12px -8px;
    }
    
    .service-name {
      font-size: 16px;
      font-weight: 600;
      color: #1a1a1a;
      flex: 1;
    }
    
    .service-staff-count {
      font-size: 12px;
      color: #666;
      background: #f0f0f0;
      padding: 4px 8px;
      border-radius: 4px;
    }
    
    .staff-variants {
      margin-top: 12px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
      display: none;
    }
    
    .staff-variants.expanded {
      display: block;
    }
    
    .staff-variant {
      padding: 8px 0;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .staff-variant:last-child {
      border-bottom: none;
    }
    
    .staff-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    
    .staff-name {
      font-weight: 500;
      color: #1a1a1a;
    }
    
    .staff-price {
      font-size: 12px;
      color: #007AFF;
      font-weight: 500;
    }
    
    .availability-info {
      font-size: 12px;
      color: #666;
      font-style: italic;
    }
    
    .availability-times {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    
    .time-slot {
      background: #e8f5e8;
      color: #2d5a2d;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .loading-state {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 400px;
      color: #666;
      font-size: 18px;
    }
    
    .error-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 400px;
      color: #d32f2f;
      text-align: center;
      padding: 20px;
    }
    
    .error-state h3 {
      margin-bottom: 12px;
      font-size: 20px;
    }
    
    .error-state p {
      margin-bottom: 8px;
      color: #666;
    }
    
    .error-state button {
      margin-top: 16px;
      background: #007AFF;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .no-data-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 400px;
      color: #666;
      text-align: center;
      padding: 20px;
    }
    
    .no-data-state h3 {
      margin-bottom: 12px;
      font-size: 20px;
      color: #1a1a1a;
    }
    
    .no-data-state p {
      margin-bottom: 8px;
    }
    
    .api-limitation-notice {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #856404;
    }
    
    .api-limitation-notice h4 {
      margin-bottom: 8px;
      color: #856404;
    }
    
    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .dashboard-container {
        padding: 10px;
      }
      
      .header-top {
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
      }
      
      .date-navigation {
        justify-content: center;
      }
      
      .filters-container {
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .locations-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="api-limitation-notice">
      <h4>üìã Client API Dashboard</h4>
      <p>This dashboard uses the Boulevard Client API, which is designed for booking flows. It shows available services and staff for booking, but cannot display existing appointments or administrative scheduling data. All availability shown is real-time booking availability.</p>
    </div>
    
    <div class="dashboard-header">
      <div class="header-top">
        <h1 class="dashboard-title">Get Plump - Service Availability Dashboard</h1>
        
        <div class="date-navigation">
          <button class="nav-button" id="prevDay">‚Üê Previous</button>
          <div class="current-date" id="currentDate">Today</div>
          <button class="nav-button" id="nextDay">Next ‚Üí</button>
        </div>
      </div>
      
      <div class="filters-container">
        <div class="filter-dropdown" id="locationFilter">
          All Locations ‚ñº
          <div class="dropdown-content" id="locationDropdown">
            <div class="dropdown-item" data-location="all">All Locations</div>
          </div>
        </div>
        
        <div class="filter-dropdown" id="serviceFilter">
          All Services ‚ñº
          <div class="dropdown-content" id="serviceDropdown">
            <div class="dropdown-item" data-service="all">All Services</div>
          </div>
        </div>
        
        <div class="filter-dropdown" id="staffFilter">
          All Staff ‚ñº
          <div class="dropdown-content" id="staffDropdown">
            <div class="dropdown-item" data-staff="all">All Staff</div>
          </div>
        </div>
        
        <button class="refresh-button" id="refreshData">Refresh</button>
        <button class="test-button" id="testAPI">Test API</button>
      </div>
      
      <div class="legend">
        <div class="legend-item">
          <div class="legend-dot status-dot available"></div>
          <span>Available Times</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot status-dot busy"></div>
          <span>Limited Availability</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot status-dot no-service"></div>
          <span>No Service Available</span>
        </div>
      </div>
    </div>
    
    <div class="dashboard-content">
      <div id="dashboard-container" class="locations-grid">
        <div class="loading-state">
          Loading service availability from Boulevard Client API...
        </div>
      </div>
    </div>
  </div>

  <script>
    // =============================================================================
    // BOULEVARD CLIENT API CONFIGURATION
    // =============================================================================

    // Configuration - Updated with your actual values
    const BOULEVARD_CONFIG = {
      businessId: 'f6a06736-1132-4365-b79a-a69c648a746a',
      apiKey: '93ca3f15-6f0e-491d-840b-681a0fef80ed',
      endpoint: 'https://dashboard.boulevard.io/api/2020-01/f6a06736-1132-4365-b79a-a69c648a746a/client'
    };

    // Global State
    let currentDate = new Date();
    let selectedLocation = 'all';
    let selectedService = 'all';
    let selectedStaff = 'all';
    let dashboardData = null;
    let activeCarts = new Map(); // Track carts created for each location

    // =============================================================================
    // BOULEVARD CLIENT API HELPER FUNCTION
    // =============================================================================

    function makeBoulevardRequest(query, variables = {}) {
      console.log('üî• Making Boulevard Client API request...');
      console.log('Query:', query.substring(0, 200) + '...');
      console.log('Variables:', variables);
      
      return fetch(BOULEVARD_CONFIG.endpoint, {
        method: 'POST',
        headers: {
          'Authorization': 'Basic ' + btoa(BOULEVARD_CONFIG.apiKey + ':'),
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          query: query,
          variables: variables
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.errors && data.errors.length > 0) {
          console.error('GraphQL errors:', data.errors);
          throw new Error(data.errors[0].message);
        }
        return data.data;
      });
    }

    // =============================================================================
    // 1. FETCH BUSINESS LOCATIONS (CLIENT API)
    // =============================================================================

    const BUSINESS_LOCATIONS_QUERY = `
      query GetBusinessLocations {
        business {
          locations(first: 20) {
            edges {
              node {
                id
                name
                tz
                address {
                  line1
                  line2
                  city
                  state
                  zip
                }
              }
            }
          }
        }
      }
    `;

    async function fetchBusinessLocations() {
      console.log('üè¢ Fetching business locations...');
      
      try {
        const data = await makeBoulevardRequest(BUSINESS_LOCATIONS_QUERY);
        
        if (!data.business || !data.business.locations || !data.business.locations.edges) {
          console.log('‚ö†Ô∏è No locations data returned');
          return [];
        }
        
        const locations = data.business.locations.edges.map(edge => edge.node);
        
        console.log(`‚úÖ Found ${locations.length} business locations`);
        locations.forEach(l => {
          console.log(`  - ${l.name} - ID: ${l.id}`);
        });
        
        return locations;
        
      } catch (error) {
        console.error('‚ùå Failed to fetch business locations:', error);
        return [];
      }
    }

    // =============================================================================
    // 2. CREATE CART FOR LOCATION TO DISCOVER SERVICES (CLIENT API)
    // =============================================================================

    const CREATE_CART_QUERY = `
      mutation CreateCart($locationId: ID!) {
        createCart(input: { locationId: $locationId }) {
          cart {
            id
            availableCategories {
              name
              availableItems {
                id
                name
                description
                ... on CartAvailableBookableItem {
                  listPrice
                  listDuration
                }
              }
            }
          }
        }
      }
    `;

    async function createCartForLocation(locationId) {
      console.log(`üõí Creating cart for location ${locationId}...`);
      
      try {
        const data = await makeBoulevardRequest(CREATE_CART_QUERY, { locationId });
        
        if (!data.createCart || !data.createCart.cart) {
          console.log(`‚ö†Ô∏è Failed to create cart for location ${locationId}`);
          return null;
        }
        
        const cart = data.createCart.cart;
        console.log(`‚úÖ Created cart ${cart.id} for location`);
        
        // Store cart for later use
        activeCarts.set(locationId, cart.id);
        
        return cart;
        
      } catch (error) {
        console.error(`‚ùå Failed to create cart for location ${locationId}:`, error);
        return null;
      }
    }

    // =============================================================================
    // 3. GET STAFF VARIANTS FOR A SERVICE (CLIENT API)
    // =============================================================================

    const GET_STAFF_VARIANTS_QUERY = `
      query GetStaffVariants($cartId: ID!, $itemId: ID!) {
        cart(id: $cartId) {
          id
          availableItem(id: $itemId) {
            id
            name
            description
            ... on CartAvailableBookableItem {
              listPrice
              listDuration
              staffVariants {
                id
                price
                duration
                staff {
                  id
                  firstName
                  lastName
                  bio
                }
              }
            }
          }
        }
      }
    `;

    async function getStaffVariantsForService(cartId, itemId) {
      console.log(`üë• Getting staff variants for service ${itemId} in cart ${cartId}...`);
      
      try {
        const data = await makeBoulevardRequest(GET_STAFF_VARIANTS_QUERY, { cartId, itemId });
        
        if (!data.cart || !data.cart.availableItem) {
          console.log(`‚ö†Ô∏è No staff variants found for service ${itemId}`);
          return [];
        }
        
        const item = data.cart.availableItem;
        const staffVariants = item.staffVariants || [];
        
        console.log(`‚úÖ Found ${staffVariants.length} staff variants for ${item.name}`);
        staffVariants.forEach(variant => {
          const staffName = variant.staff ? `${variant.staff.firstName} ${variant.staff.lastName}` : 'Unknown Staff';
          console.log(`  - ${staffName}: $${variant.price} (${variant.duration}min)`);
        });
        
        return staffVariants.map(variant => ({
          ...variant,
          serviceName: item.name,
          serviceId: item.id
        }));
        
      } catch (error) {
        console.error(`‚ùå Failed to get staff variants for service ${itemId}:`, error);
        return [];
      }
    }

    // =============================================================================
    // 4. GET AVAILABLE DATES FOR CART (CLIENT API)
    // =============================================================================

    const GET_AVAILABLE_DATES_QUERY = `
      query GetAvailableDates($cartId: ID!, $searchRangeLower: String!, $searchRangeUpper: String!, $tz: String!) {
        cartBookableDates(
          id: $cartId,
          searchRangeLower: $searchRangeLower,
          searchRangeUpper: $searchRangeUpper,
          tz: $tz
        ) {
          date
        }
      }
    `;

    async function getAvailableDatesForCart(cartId, startDate, endDate, timezone = 'America/New_York') {
      console.log(`üìÖ Getting available dates for cart ${cartId}...`);
      
      try {
        const data = await makeBoulevardRequest(GET_AVAILABLE_DATES_QUERY, {
          cartId,
          searchRangeLower: startDate,
          searchRangeUpper: endDate,
          tz: timezone
        });
        
        const availableDates = data.cartBookableDates || [];
        
        console.log(`‚úÖ Found ${availableDates.length} available dates`);
        
        return availableDates;
        
      } catch (error) {
        console.error(`‚ùå Failed to get available dates for cart ${cartId}:`, error);
        return [];
      }
    }

    // =============================================================================
    // 5. GET AVAILABLE TIMES FOR A SPECIFIC DATE (CLIENT API)
    // =============================================================================

    const GET_AVAILABLE_TIMES_QUERY = `
      query GetAvailableTimes($cartId: ID!, $searchDate: String!, $tz: String!) {
        cartBookableTimes(
          id: $cartId,
          searchDate: $searchDate,
          tz: $tz
        ) {
          id
          score
          startTime
        }
      }
    `;

    async function getAvailableTimesForDate(cartId, date, timezone = 'America/New_York') {
      console.log(`‚è∞ Getting available times for cart ${cartId} on ${date}...`);
      
      try {
        const data = await makeBoulevardRequest(GET_AVAILABLE_TIMES_QUERY, {
          cartId,
          searchDate: date,
          tz: timezone
        });
        
        const availableTimes = data.cartBookableTimes || [];
        
        console.log(`‚úÖ Found ${availableTimes.length} available times for ${date}`);
        
        return availableTimes;
        
      } catch (error) {
        console.error(`‚ùå Failed to get available times for cart ${cartId} on ${date}:`, error);
        return [];
      }
    }

    // =============================================================================
    // 6. ADD SERVICE TO CART (REQUIRED FOR AVAILABILITY CHECKING)
    // =============================================================================

    const ADD_SERVICE_TO_CART_QUERY = `
      mutation AddServiceToCart($cartId: ID!, $itemId: ID!, $staffVariantId: ID!) {
        addCartSelectedBookableItem(input: {
          id: $cartId,
          itemId: $itemId,
          itemStaffVariantId: $staffVariantId
        }) {
          cart { 
            id 
            selectedItems {
              id
              item {
                id
                name
              }
            }
          }
        }
      }
    `;

    async function addServiceToCart(cartId, itemId, staffVariantId) {
      console.log(`‚ûï Adding service ${itemId} (staff variant ${staffVariantId}) to cart ${cartId}...`);
      
      try {
        const data = await makeBoulevardRequest(ADD_SERVICE_TO_CART_QUERY, {
          cartId,
          itemId,
          staffVariantId
        });
        
        if (!data.addCartSelectedBookableItem || !data.addCartSelectedBookableItem.cart) {
          console.log(`‚ö†Ô∏è Failed to add service to cart`);
          return false;
        }
        
        console.log(`‚úÖ Added service to cart successfully`);
        return true;
        
      } catch (error) {
        console.error(`‚ùå Failed to add service to cart:`, error);
        return false;
      }
    }

    // =============================================================================
    // 7. COMPREHENSIVE DATA LOADING FOR DASHBOARD
    // =============================================================================

    async function loadDashboardData(selectedDate) {
      console.log(`üîÑ Loading dashboard data for ${selectedDate.toISOString().split('T')[0]}...`);
      
      try {
        // Step 1: Get all business locations
        const locations = await fetchBusinessLocations();
        
        if (locations.length === 0) {
          return { error: 'No business locations found' };
        }
        
        // Filter locations if needed
        const locationsToProcess = selectedLocation === 'all' ? 
          locations : 
          locations.filter(loc => loc.name === selectedLocation);
        
        // Step 2: For each location, create cart and discover services/staff
        const locationData = await Promise.all(
          locationsToProcess.map(async location => {
            console.log(`üè¢ Processing location: ${location.name}...`);
            
            // Create cart for this location
            const cart = await createCartForLocation(location.id);
            
            if (!cart) {
              return {
                location,
                services: [],
                error: 'Failed to create cart for location'
              };
            }
            
            // Get all available services from cart
            const services = [];
            const allStaffVariants = [];
            
            if (cart.availableCategories) {
              for (const category of cart.availableCategories) {
                for (const item of category.availableItems) {
                  // Get staff variants for this service
                  const staffVariants = await getStaffVariantsForService(cart.id, item.id);
                  
                  if (staffVariants.length > 0) {
                    // For each staff variant, get availability for the selected date
                    const staffWithAvailability = await Promise.all(
                      staffVariants.map(async variant => {
                        // Add this service/staff to cart to check availability
                        const added = await addServiceToCart(cart.id, item.id, variant.id);
                        
                        if (added) {
                          // Get available times for selected date
                          const dateStr = selectedDate.toISOString().split('T')[0];
                          const availableTimes = await getAvailableTimesForDate(cart.id, dateStr, location.tz);
                          
                          return {
                            ...variant,
                            availableTimes,
                            hasAvailability: availableTimes.length > 0
                          };
                        }
                        
                        return {
                          ...variant,
                          availableTimes: [],
                          hasAvailability: false
                        };
                      })
                    );
                    
                    services.push({
                      id: item.id,
                      name: item.name,
                      description: item.description,
                      category: category.name,
                      staffVariants: staffWithAvailability
                    });
                    
                    allStaffVariants.push(...staffWithAvailability);
                  }
                }
              }
            }
            
            console.log(`‚úÖ ${location.name}: ${services.length} services, ${allStaffVariants.length} total staff variants`);
            
            return {
              location,
              services,
              cart,
              allStaffVariants
            };
          })
        );
        
        // Step 3: Aggregate all services and staff for filters
        const allServices = [];
        const allStaff = new Map();
        
        locationData.forEach(locData => {
          if (locData.services) {
            locData.services.forEach(service => {
              // Add to all services if not already present
              if (!allServices.find(s => s.name === service.name)) {
                allServices.push(service);
              }
              
              // Add staff to global staff map
              service.staffVariants.forEach(variant => {
                if (variant.staff) {
                  const staffKey = variant.staff.id;
                  if (!allStaff.has(staffKey)) {
                    allStaff.set(staffKey, {
                      ...variant.staff,
                      services: [service.name],
                      locations: [locData.location.name]
                    });
                  } else {
                    const existingStaff = allStaff.get(staffKey);
                    if (!existingStaff.services.includes(service.name)) {
                      existingStaff.services.push(service.name);
                    }
                    if (!existingStaff.locations.includes(locData.location.name)) {
                      existingStaff.locations.push(locData.location.name);
                    }
                  }
                }
              });
            });
          }
        });
        
        console.log('‚úÖ Dashboard data loaded successfully');
        
        return {
          locations,
          allServices,
          allStaff: Array.from(allStaff.values()),
          locationData
        };
        
      } catch (error) {
        console.error('‚ùå Failed to load dashboard data:', error);
        return { error: error.message };
      }
    }

    // =============================================================================
    // 8. TEST FUNCTION FOR CLIENT API
    // =============================================================================

    async function testClientAPI() {
      console.log('üß™ Testing Boulevard Client API endpoints...');
      
      try {
        // Test 1: Business locations
        console.log('Test 1: Fetching business locations...');
        const locations = await fetchBusinessLocations();
        console.log(`‚úÖ Locations test: ${locations.length} found`);
        
        if (locations.length > 0) {
          const firstLocation = locations[0];
          console.log(`First location: ${firstLocation.name} (${firstLocation.id})`);
          
          // Test 2: Create cart for first location
          console.log('Test 2: Creating cart for first location...');
          const cart = await createCartForLocation(firstLocation.id);
          
          if (cart) {
            console.log(`‚úÖ Cart created: ${cart.id}`);
            console.log(`Available categories: ${cart.availableCategories?.length || 0}`);
            
            // Test 3: Get staff variants for first service
            if (cart.availableCategories && cart.availableCategories.length > 0) {
              const firstCategory = cart.availableCategories[0];
              if (firstCategory.availableItems && firstCategory.availableItems.length > 0) {
                const firstItem = firstCategory.availableItems[0];
                console.log('Test 3: Getting staff variants for first service...');
                const staffVariants = await getStaffVariantsForService(cart.id, firstItem.id);
                console.log(`‚úÖ Staff variants test: ${staffVariants.length} found`);
              }
            }
          }
        }
        
        console.log('üéâ All Client API tests completed successfully!');
        
      } catch (error) {
        console.error('üí• Client API test failed:', error);
        throw error;
      }
    }

    // =============================================================================
    // 9. RENDER DASHBOARD WITH CLIENT API DATA
    // =============================================================================

    function renderDashboard(data) {
      const container = document.getElementById('dashboard-container');
      
      if (data.error) {
        container.innerHTML = `
          <div class="error-state">
            <h3>Error Loading Data</h3>
            <p>${data.error}</p>
            <p>Please check your Boulevard configuration and API key.</p>
            <button onclick="loadAndRenderDashboard()">Retry</button>
          </div>
        `;
        return;
      }
      
      if (!data.locationData || data.locationData.length === 0) {
        container.innerHTML = `
          <div class="no-data-state">
            <h3>No Data Found</h3>
            <p>No locations or services found in your Boulevard business.</p>
            <p>Please check your business setup and try again.</p>
            <button onclick="loadAndRenderDashboard()">Retry</button>
          </div>
        `;
        return;
      }
      
      // Clear container
      container.innerHTML = '';
      
      // Render each location
      data.locationData.forEach(locationInfo => {
        const locationPanel = createLocationPanel(locationInfo);
        container.appendChild(locationPanel);
      });
    }

    function createLocationPanel(locationInfo) {
      const panel = document.createElement('div');
      panel.className = 'location-panel';
      
      // Location header
      const header = document.createElement('div');
      header.className = 'location-header';
      
      const addressStr = locationInfo.location.address ? 
        `${locationInfo.location.address.city}, ${locationInfo.location.address.state}` : 
        'No address';
      
      header.innerHTML = `
        <div>
          <div class="location-name">${locationInfo.location.name}</div>
          <div class="location-address">${addressStr}</div>
        </div>
        <div class="location-stats">
          <div class="stat-item">
            <span>${locationInfo.services?.length || 0} services</span>
          </div>
          <div class="stat-item">
            <span>${locationInfo.allStaffVariants?.length || 0} staff options</span>
          </div>
        </div>
      `;
      panel.appendChild(header);
      
      // Error handling for location
      if (locationInfo.error) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-state';
        errorDiv.innerHTML = `
          <h3>Location Error</h3>
          <p>${locationInfo.error}</p>
        `;
        panel.appendChild(errorDiv);
        return panel;
      }
      
      // Services list
      if (!locationInfo.services || locationInfo.services.length === 0) {
        const noServices = document.createElement('div');
        noServices.className = 'no-data-state';
        noServices.innerHTML = `
          <h3>No Services Available</h3>
          <p>No bookable services found for this location.</p>
        `;
        panel.appendChild(noServices);
      } else {
        // Filter services if needed
        const servicesToShow = selectedService === 'all' ? 
          locationInfo.services : 
          locationInfo.services.filter(service => service.name === selectedService);
        
        servicesToShow.forEach(service => {
          const serviceSection = createServiceSection(service);
          panel.appendChild(serviceSection);
        });
      }
      
      return panel;
    }

    function createServiceSection(service) {
      const section = document.createElement('div');
      section.className = 'service-section';
      
      // Filter staff variants if needed
      const staffToShow = selectedStaff === 'all' ? 
        service.staffVariants : 
        service.staffVariants.filter(variant => 
          variant.staff && (variant.staff.id === selectedStaff || 
          `${variant.staff.firstName} ${variant.staff.lastName}` === selectedStaff)
        );
      
      // Service header
      const header = document.createElement('div');
      header.className = 'service-header';
      header.innerHTML = `
        <div class="service-name">${service.name}</div>
        <div class="service-staff-count">${staffToShow.length} staff</div>
      `;
      
      // Make header clickable to expand/collapse
      header.addEventListener('click', () => {
        const staffVariants = section.querySelector('.staff-variants');
        staffVariants.classList.toggle('expanded');
      });
      
      section.appendChild(header);
      
      // Staff variants container
      const staffVariantsContainer = document.createElement('div');
      staffVariantsContainer.className = 'staff-variants';
      
      if (staffToShow.length === 0) {
        staffVariantsContainer.innerHTML = '<div class="availability-info">No staff available for this service</div>';
      } else {
        staffToShow.forEach(variant => {
          const staffDiv = createStaffVariantDiv(variant);
          staffVariantsContainer.appendChild(staffDiv);
        });
      }
      
      section.appendChild(staffVariantsContainer);
      
      return section;
    }

    function createStaffVariantDiv(variant) {
      const div = document.createElement('div');
      div.className = 'staff-variant';
      
      const staffName = variant.staff ? 
        `${variant.staff.firstName} ${variant.staff.lastName}` : 
        'Unknown Staff';
      
      const staffInfo = document.createElement('div');
      staffInfo.className = 'staff-info';
      staffInfo.innerHTML = `
        <div class="staff-name">${staffName}</div>
        <div class="staff-price">$${variant.price} (${variant.duration}min)</div>
      `;
      div.appendChild(staffInfo);
      
      // Availability info
      const availabilityInfo = document.createElement('div');
      availabilityInfo.className = 'availability-info';
      
      if (variant.hasAvailability && variant.availableTimes.length > 0) {
        availabilityInfo.textContent = `${variant.availableTimes.length} available times`;
        
        // Show first few time slots
        const timesContainer = document.createElement('div');
        timesContainer.className = 'availability-times';
        
        variant.availableTimes.slice(0, 6).forEach(time => {
          const timeSlot = document.createElement('span');
          timeSlot.className = 'time-slot';
          timeSlot.textContent = new Date(`2000-01-01T${time.startTime}`).toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          });
          timesContainer.appendChild(timeSlot);
        });
        
        if (variant.availableTimes.length > 6) {
          const moreSlot = document.createElement('span');
          moreSlot.className = 'time-slot';
          moreSlot.textContent = `+${variant.availableTimes.length - 6} more`;
          timesContainer.appendChild(moreSlot);
        }
        
        div.appendChild(timesContainer);
      } else {
        availabilityInfo.textContent = 'No availability for selected date';
      }
      
      div.appendChild(availabilityInfo);
      
      return div;
    }

    // =============================================================================
    // 10. POPULATE FILTER DROPDOWNS
    // =============================================================================

    function populateLocationFilter(locations) {
      const dropdown = document.getElementById('locationDropdown');
      dropdown.innerHTML = '<div class="dropdown-item" data-location="all">All Locations</div>';
      
      locations.forEach(location => {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        item.setAttribute('data-location', location.name);
        item.textContent = location.name;
        dropdown.appendChild(item);
      });
    }

    function populateServiceFilter(services) {
      const dropdown = document.getElementById('serviceDropdown');
      dropdown.innerHTML = '<div class="dropdown-item" data-service="all">All Services</div>';
      
      services.forEach(service => {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        item.setAttribute('data-service', service.name);
        item.textContent = service.name;
        dropdown.appendChild(item);
      });
    }

    function populateStaffFilter(staff) {
      const dropdown = document.getElementById('staffDropdown');
      dropdown.innerHTML = '<div class="dropdown-item" data-staff="all">All Staff</div>';
      
      staff.forEach(member => {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        item.setAttribute('data-staff', member.id);
        item.textContent = `${member.firstName} ${member.lastName} (${member.services.join(', ')})`;
        dropdown.appendChild(item);
      });
    }

    // =============================================================================
    // 11. UPDATE DATE DISPLAY
    // =============================================================================

    function updateDateDisplay() {
      const dateElement = document.getElementById('currentDate');
      const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      };
      dateElement.textContent = currentDate.toLocaleDateString('en-US', options);
    }

    // =============================================================================
    // 12. MAIN INITIALIZATION FUNCTION
    // =============================================================================

    async function loadAndRenderDashboard() {
      console.log('üöÄ Initializing Boulevard Client API Dashboard...');
      
      // Show loading state
      const container = document.getElementById('dashboard-container');
      container.innerHTML = '<div class="loading-state">Loading service availability from Boulevard Client API...</div>';
      
      // Load and render data
      dashboardData = await loadDashboardData(currentDate);
      
      // Populate filters if we have data
      if (dashboardData && !dashboardData.error) {
        populateLocationFilter(dashboardData.locations);
        populateServiceFilter(dashboardData.allServices);
        populateStaffFilter(dashboardData.allStaff);
      }
      
      renderDashboard(dashboardData);
    }

    // =============================================================================
    // 13. EVENT LISTENERS
    // =============================================================================

    document.addEventListener('DOMContentLoaded', function() {
      console.log('üì± Page loaded, starting Boulevard Client API dashboard...');
      
      // Check configuration
      if (BOULEVARD_CONFIG.businessId.includes('YOUR_') || BOULEVARD_CONFIG.apiKey.includes('YOUR_')) {
        const container = document.getElementById('dashboard-container');
        container.innerHTML = `
          <div class="error-state">
            <h3>Configuration Required</h3>
            <p>Please update the BOULEVARD_CONFIG object with your actual business ID and API key.</p>
            <p>Find the configuration at the top of the JavaScript section.</p>
          </div>
        `;
        return;
      }
      
      // Initialize date display
      updateDateDisplay();
      
      // Load initial data
      loadAndRenderDashboard();
      
      // Date navigation
      document.getElementById('prevDay').addEventListener('click', () => {
        currentDate.setDate(currentDate.getDate() - 1);
        updateDateDisplay();
        loadAndRenderDashboard();
      });
      
      document.getElementById('nextDay').addEventListener('click', () => {
        currentDate.setDate(currentDate.getDate() + 1);
        updateDateDisplay();
        loadAndRenderDashboard();
      });
      
      // Location filter
      document.getElementById('locationFilter').addEventListener('click', () => {
        const dropdown = document.getElementById('locationDropdown');
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
      });
      
      document.getElementById('locationDropdown').addEventListener('click', (e) => {
        if (e.target.classList.contains('dropdown-item')) {
          selectedLocation = e.target.getAttribute('data-location');
          document.getElementById('locationFilter').textContent = e.target.textContent + ' ‚ñº';
          document.getElementById('locationDropdown').style.display = 'none';
          loadAndRenderDashboard();
        }
      });
      
      // Service filter
      document.getElementById('serviceFilter').addEventListener('click', () => {
        const dropdown = document.getElementById('serviceDropdown');
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
      });
      
      document.getElementById('serviceDropdown').addEventListener('click', (e) => {
        if (e.target.classList.contains('dropdown-item')) {
          selectedService = e.target.getAttribute('data-service');
          document.getElementById('serviceFilter').textContent = e.target.textContent + ' ‚ñº';
          document.getElementById('serviceDropdown').style.display = 'none';
          loadAndRenderDashboard();
        }
      });
      
      // Staff filter
      document.getElementById('staffFilter').addEventListener('click', () => {
        const dropdown = document.getElementById('staffDropdown');
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
      });
      
      document.getElementById('staffDropdown').addEventListener('click', (e) => {
        if (e.target.classList.contains('dropdown-item')) {
          selectedStaff = e.target.getAttribute('data-staff');
          document.getElementById('staffFilter').textContent = e.target.textContent + ' ‚ñº';
          document.getElementById('staffDropdown').style.display = 'none';
          loadAndRenderDashboard();
        }
      });
      
      // Refresh button
      document.getElementById('refreshData').addEventListener('click', () => {
        // Clear cached carts
        activeCarts.clear();
        loadAndRenderDashboard();
      });
      
      // Test API button
      document.getElementById('testAPI').addEventListener('click', () => {
        testClientAPI();
      });
      
      // Close dropdowns when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.filter-dropdown')) {
          document.querySelectorAll('.dropdown-content').forEach(dropdown => {
            dropdown.style.display = 'none';
          });
        }
      });
    });

    // Export functions for manual testing
    window.boulevardClientAPI = {
      fetchBusinessLocations,
      createCartForLocation,
      getStaffVariantsForService,
      getAvailableDatesForCart,
      getAvailableTimesForDate,
      addServiceToCart,
      loadDashboardData,
      testClientAPI,
      makeBoulevardRequest
    };

    console.log('‚úÖ Boulevard Client API dashboard loaded');
    console.log('üß™ Run window.boulevardClientAPI.testClientAPI() to test your API connection');
    console.log('‚ö†Ô∏è Remember to update BOULEVARD_CONFIG with your actual business ID and API key');
  </script>
</body>
</html>
